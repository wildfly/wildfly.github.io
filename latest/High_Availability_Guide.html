<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<meta name="author" content="WildFly clustering team">
<title>High Availability Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body id="High_Availability_Guide" class="book toc2 toc-left">
<div id="header">
<h1>High Availability Guide</h1>
<div class="details">
<span id="author" class="author">WildFly clustering team</span><br>
<span id="revnumber">version 32.0.0.Final,</span>
<span id="revdate">2024-04-24T21:31:14Z</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">High Availability Guide</div>
<ul class="sectlevel1">
<li><a href="#Introduction_To_High_Availability_Services">1. Introduction To High Availability Services</a>
<ul class="sectlevel2">
<li><a href="#what-are-high-availability-services">1.1. What are High Availability services?</a></li>
<li><a href="#high-availability-through-fail-over">1.2. High Availability through fail-over</a></li>
<li><a href="#high-availability-through-load-balancing">1.3. High Availability through load balancing</a></li>
<li><a href="#aims-of-the-guide">1.4. Aims of the guide</a></li>
<li><a href="#organization-of-the-guide">1.5. Organization of the guide</a></li>
</ul>
</li>
<li><a href="#Distributable_Web_Applications">2. Distributable Web Applications</a>
<ul class="sectlevel2">
<li><a href="#distributable-web-subsystem">2.1. Distributable Web Subsystem</a>
<ul class="sectlevel3">
<li><a href="#infinispan-session-management">2.1.1. Infinispan session management</a></li>
<li><a href="#hotrod-session-management">2.1.2. HotRod session management</a></li>
</ul>
</li>
<li><a href="#overriding-default-behavior">2.2. Overriding default behavior</a>
<ul class="sectlevel3">
<li><a href="#referencing-an-existing-session-management-profile">2.2.1. Referencing an existing session management profile</a></li>
<li><a href="#using-a-deployment-specific-session-management-profile">2.2.2. Using a deployment-specific session management profile</a></li>
</ul>
</li>
<li><a href="#distributable-shared-sessions">2.3. Distributable Shared Sessions</a></li>
<li><a href="#optimizing-performance-of-distributed-web-applications">2.4. Optimizing performance of distributed web applications</a>
<ul class="sectlevel3">
<li><a href="#session_granularity">2.4.1. Session granularity</a></li>
<li><a href="#session_concurrency">2.4.2. Session concurrency</a></li>
<li><a href="#session_attribute_immutability">2.4.3. Session attribute immutability</a></li>
<li><a href="#session_attribute_marshalling">2.4.4. Session attribute marshalling</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Distributable_Jakarta_Enterprise_Beans_Applications">3. Distributable Jakarta Enterprise Beans Applications</a>
<ul class="sectlevel2">
<li><a href="#distributable-ejb-subsystem">3.1. Distributable EJB Subsystem</a>
<ul class="sectlevel3">
<li><a href="#bean-management-providers">3.1.1. Bean management providers</a></li>
<li><a href="#client-mappings-registries">3.1.2. Client mappings registries</a></li>
<li><a href="#timer-management">3.1.3. Timer management</a></li>
</ul>
</li>
<li><a href="#deploying-clustered-ejbs">3.2. Deploying clustered EJBs</a>
<ul class="sectlevel3">
<li><a href="#failover-for-clustered-ejbs">3.2.1. Failover for clustered EJBs</a></li>
<li><a href="#remote-standalone-clients">3.2.2. Remote standalone clients</a></li>
<li><a href="#cluster-topology-communication">3.2.3. Cluster topology communication</a></li>
<li><a href="#remote-clients-on-another-instance">3.2.4. Remote clients on another instance of WildFly</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#messaging">4. Messaging</a></li>
<li><a href="#load-balancing">5. Load Balancing</a>
<ul class="sectlevel2">
<li><a href="#mod_cluster_Subsystem">5.1. mod_cluster Subsystem</a>
<ul class="sectlevel3">
<li><a href="#mod_cluster_subsystem_configuration">5.1.1. Configuration</a></li>
<li><a href="#runtime-operations">5.1.2. Runtime Operations</a></li>
<li><a href="#SSL_Configuration_using_Elytron_Subsystem">5.1.3. SSL Configuration using Elytron Subsystem</a></li>
<li><a href="#remote-user-authentication-with-elytron">5.1.4. Remote User Authentication with Elytron</a></li>
</ul>
</li>
<li><a href="#ranked-affinity-load-balancer">5.2. Enabling ranked affinity support in load balancer</a></li>
<li><a href="#load-balancer-affinity-cookie">5.3. Support for load-balancers relying on affinity cookie</a>
<ul class="sectlevel3">
<li><a href="#haproxy">5.3.1. HAProxy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clustering-in-the-cloud">6. Clustering in the Cloud</a>
<ul class="sectlevel2">
<li><a href="#kubernetes">6.1. Kubernetes</a>
<ul class="sectlevel3">
<li><a href="#role-of-the-distributed-cache-mode">6.1.1. Role of the Distributed Cache Mode</a></li>
<li><a href="#ingress-configuration">6.1.2. Ingress Configuration</a></li>
<li><a href="#verifying-session-affinity">6.1.3. Verifying Session Affinity</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#HA_Singleton_Features">7. HA Singleton Features</a>
<ul class="sectlevel2">
<li><a href="#Singleton_subsystem">7.1. Singleton subsystem</a>
<ul class="sectlevel3">
<li><a href="#singleton-configuration">7.1.1. Configuration</a></li>
<li><a href="#non-ha-environments">7.1.2. Non-HA environments</a></li>
</ul>
</li>
<li><a href="#Singleton_deployments">7.2. Singleton deployments</a>
<ul class="sectlevel3">
<li><a href="#usage-singleton-deployments">7.2.1. Usage</a></li>
<li><a href="#singleton-deployment-metrics">7.2.2. Singleton Deployment metrics</a></li>
</ul>
</li>
<li><a href="#Singleton_MSC_services">7.3. Singleton MSC services</a>
<ul class="sectlevel3">
<li><a href="#installing-an-msc-service-using-an-existing-singleton-policy">7.3.1. Installing an MSC service using an existing singleton policy</a></li>
<li><a href="#singleton-msc-service-metrics">7.3.2. Singleton MSC Service metrics</a></li>
<li><a href="#installing-an-msc-service-using-dynamic-singleton-policy">7.3.3. Installing an MSC service using dynamic singleton policy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Clustering_API">8. Clustering API</a>
<ul class="sectlevel2">
<li><a href="#group">8.1. Group membership</a>
<ul class="sectlevel3">
<li><a href="#node">8.1.1. Node</a></li>
<li><a href="#membership">8.1.2. Membership</a></li>
<li><a href="#usage">8.1.3. Usage</a></li>
<li><a href="#example">8.1.4. Example</a></li>
</ul>
</li>
<li><a href="#command-dispatcher">8.2. Command Dispatcher</a>
<ul class="sectlevel3">
<li><a href="#commanddispatcherfactory">8.2.1. CommandDispatcherFactory</a></li>
<li><a href="#command">8.2.2. Command</a></li>
<li><a href="#commanddispatcher">8.2.3. CommandDispatcher</a></li>
<li><a href="#example-2">8.2.4. Example</a></li>
</ul>
</li>
<li><a href="#service-provider-registry">8.3. Service Provider Registry</a>
<ul class="sectlevel3">
<li><a href="#example-3">8.3.1. Example</a></li>
</ul>
</li>
<li><a href="#registry">8.4. Registry</a>
<ul class="sectlevel3">
<li><a href="#example-4">8.4.1. Example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#jgroups">9. JGroups</a>
<ul class="sectlevel2">
<li><a href="#JGroups_Subsystem">9.1. JGroups Subsystem</a>
<ul class="sectlevel3">
<li><a href="#jgroups-purpose">9.1.1. Purpose</a></li>
<li><a href="#jgroups-configuration-example">9.1.2. Configuration example</a></li>
<li><a href="#jgroups-use-cases">9.1.3. Use Cases</a></li>
</ul>
</li>
<li><a href="#member-discovery">9.2. Member Discovery</a>
<ul class="sectlevel3">
<li><a href="#discovery-for-kubernetes">9.2.1. Discovery for Kubernetes</a></li>
<li><a href="#discovery-for-aws-ec2">9.2.2. Discovery for AWS EC2</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#infinispan">10. Infinispan</a>
<ul class="sectlevel2">
<li><a href="#Infinispan_Subsystem">10.1. Infinispan Subsystem</a>
<ul class="sectlevel3">
<li><a href="#cache-container">10.1.1. Cache container</a></li>
<li><a href="#remote_cache_container">10.1.2. Remote Cache Container</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#advanced-topics">11. Advanced Topics</a>
<ul class="sectlevel2">
<li><a href="#marshalling">11.1. Marshalling</a>
<ul class="sectlevel3">
<li><a href="#jboss_marshalling">11.1.1. JBoss Marshalling</a></li>
<li><a href="#protostream">11.1.2. ProtoStream</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Clustering_and_Domain_Setup_Walkthrough">12. Clustering and Domain Setup Walkthrough</a>
<ul class="sectlevel2">
<li><a href="#preparation-scenario">12.1. Preparation &amp; Scenario</a>
<ul class="sectlevel3">
<li><a href="#preparation">12.1.1. Preparation</a></li>
<li><a href="#scenario">12.1.2. Scenario</a></li>
</ul>
</li>
<li><a href="#download-wildfly">12.2. Download WildFly</a></li>
<li><a href="#domain-configuration">12.3. Domain Configuration</a>
<ul class="sectlevel3">
<li><a href="#interface-config-on-primary-hc">12.3.1. Interface config on the Primary Host Controller</a></li>
<li><a href="#interface-config-on-secondary-hc">12.3.2. Interface config on the Secondary Host Controller</a></li>
</ul>
</li>
<li><a href="#deployment">12.4. Deployment</a></li>
<li><a href="#cluster-configuration">12.5. Cluster Configuration</a></li>
<li><a href="#testing">12.6. Testing</a></li>
<li><a href="#special-thanks">12.7. Special Thanks</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; 2017–2022 The original authors.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect1">
<h2 id="Introduction_To_High_Availability_Services"><a class="anchor" href="#Introduction_To_High_Availability_Services"></a>1. Introduction To High Availability Services</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="what-are-high-availability-services"><a class="anchor" href="#what-are-high-availability-services"></a>1.1. What are High Availability services?</h3>
<div class="paragraph">
<p>WildFly&#8217;s High Availability services are used to guarantee availability
of a deployed Jakarta EE application.</p>
</div>
<div class="paragraph">
<p>Deploying critical applications on a single node suffers from two
potential problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>loss of application availability when the node hosting the application
crashes (single point of failure)</p>
</li>
<li>
<p>loss of application availability in the form of extreme delays in
response time during high volumes of requests (overwhelmed server)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WildFly supports two features which ensure high availability of critical
Jakarta EE applications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>fail-over:</strong> allows a client interacting with a Jakarta EE application to
have uninterrupted access to that application, even in the presence of
node failures</p>
</li>
<li>
<p><strong>load balancing:</strong> allows a client to have timely responses from the
application, even in the presence of high-volumes of requests</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
These two independent high availability services can very effectively
inter-operate when making use of mod_cluster for load balancing!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Taking advantage of WildFly&#8217;s high availability services is easy, and
simply involves deploying WildFly on a cluster of nodes, making a small
number of application configuration changes, and then deploying the
application in the cluster.</p>
</div>
<div class="paragraph">
<p>We now take a brief look at what these services can guarantee.</p>
</div>
</div>
<div class="sect2">
<h3 id="high-availability-through-fail-over"><a class="anchor" href="#high-availability-through-fail-over"></a>1.2. High Availability through fail-over</h3>
<div class="paragraph">
<p>Fail-over allows a client interacting with a Jakarta EE application to have
uninterrupted access to that application, even in the presence of node
failures. For example, consider a Jakarta EE application which makes use of
the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>session-oriented servlets to provide user interaction</p>
</li>
<li>
<p>session-oriented Jakarta Enterprise Beans to perform state-dependent business computation</p>
</li>
<li>
<p>Jakarta Enterprise Beans entity beans to store critical data in a persistent store (e.g.
database)</p>
</li>
<li>
<p>SSO login to the application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the application makes use of WildFly&#8217;s fail-over services, a client
interacting with an instance of that application will not be interrupted
even when the node on which that instance executes crashes. Behind the
scenes, WildFly makes sure that all of the user data that the
application make use of (HTTP session data, Jakarta Enterprise Beans SFSB sessions,
Jakarta Enterprise Beans entities and SSO credentials) are available at other nodes in the
cluster, so that when a failure occurs and the client is redirected to
that new node for continuation of processing (i.e. the client "fails
over" to the new node), the user&#8217;s data is available and processing can
continue.</p>
</div>
<div class="paragraph">
<p>The Infinispan and JGroups subsystems are instrumental in providing
these data availability guarantees and will be discussed in detail later
in the guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="high-availability-through-load-balancing"><a class="anchor" href="#high-availability-through-load-balancing"></a>1.3. High Availability through load balancing</h3>
<div class="paragraph">
<p>Load balancing enables the application to respond to client requests in
a timely fashion, even when subjected to a high-volume of requests.
Using a load balancer as a front-end, each incoming HTTP request can be
directed to one node in the cluster for processing. In this way, the
cluster acts as a pool of processing nodes and the load is "balanced"
over the pool, achieving scalability and, as a consequence,
availability. Requests involving session-oriented servlets are directed
to the the same application instance in the pool for efficiency of
processing (sticky sessions). Using mod_cluster has the advantage that
changes in cluster topology (scaling the pool up or down, servers
crashing) are communicated back to the load balancer and used to update
in real time the load balancing activity and avoid requests being
directed to application instances which are no longer available.</p>
</div>
<div class="paragraph">
<p>The mod_cluster subsystem is instrumental in providing support for this
High Availability feature of WildFly and will be discussed in detail
later in this guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="aims-of-the-guide"><a class="anchor" href="#aims-of-the-guide"></a>1.4. Aims of the guide</h3>
<div class="paragraph">
<p>This guide aims to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>provide a description of the high-availability features available in
WildFly and the services they depend on</p>
</li>
<li>
<p>show how the various high availability services can be configured for
particular application use cases</p>
</li>
<li>
<p>identify default behavior for features relating to
high-availability/clustering</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="organization-of-the-guide"><a class="anchor" href="#organization-of-the-guide"></a>1.5. Organization of the guide</h3>
<div class="paragraph">
<p>As high availability features and their configuration depend on the
particular component they affect (e.g. HTTP sessions, Jakarta Enterprise Beans SFSB sessions,
Hibernate), we organize the discussion around those Jakarta EE features. We
strive to make each section as self-contained as possible. Also, when
discussing a feature, we will introduce any WildFly subsystems upon
which the feature depends.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Distributable_Web_Applications"><a class="anchor" href="#Distributable_Web_Applications"></a>2. Distributable Web Applications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a standard web application, session state does not survive beyond the lifespan of the servlet container.
A distributable web application allows session state to survive beyond the lifespan of a single server, either via persistence or by replicating state to other nodes in the cluster.
A web application indicates its intention to be distributable via the <code>&lt;distributable/&gt;</code> element within the web application&#8217;s deployment descriptor.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="title">/WEB-INF/web.xml:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;web-app</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;distributable</span><span class="tag">/&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="distributable-web-subsystem"><a class="anchor" href="#distributable-web-subsystem"></a>2.1. Distributable Web Subsystem</h3>
<div class="paragraph">
<p>The distributable-web subsystem manages a set of session management profiles that encapsulate the configuration of a distributable session manager.
One of these profiles will be designated as the default profile (via the "default-session-management" attribute) and thus defines the default behavior of a distributable web application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[standalone@embedded /] /subsystem=distributable-web:read-attribute(name=default-session-management)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; &quot;default&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default session management stores web session data within an Infinispan cache.
We can introspect its configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[standalone@embedded /] /subsystem=distributable-web/infinispan-session-management=default:read-resource
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; {
        &quot;cache&quot; =&gt; undefined,
        &quot;cache-container&quot; =&gt; &quot;web&quot;,
        &quot;granularity&quot; =&gt; &quot;SESSION&quot;,
        &quot;affinity&quot; =&gt; {&quot;primary-owner&quot; =&gt; undefined}
    }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="infinispan-session-management"><a class="anchor" href="#infinispan-session-management"></a>2.1.1. Infinispan session management</h4>
<div class="paragraph">
<p>The <code>infinispan-session-management</code> resource configures a distributable session manager that uses an embedded Infinispan cache.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">cache-container</dt>
<dd>
<p>This references a cache-container defined in the Infinispan subsystem into which session data will be stored.</p>
</dd>
<dt class="hdlist1">cache</dt>
<dd>
<p>This references a cache within associated cache-container upon whose configuration the web application&#8217;s cache will be based.
If undefined, the default cache of the associated cache container will be used.</p>
</dd>
<dt class="hdlist1">granularity</dt>
<dd>
<p>This defines how the session manager will map a session into individual cache entries.
Possible values are:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">SESSION</dt>
<dd>
<p>Stores all session attributes within a single cache entry.
This is generally more expensive than ATTRIBUTE granularity, but preserves any cross-attribute object references.</p>
</dd>
<dt class="hdlist1">ATTRIBUTE</dt>
<dd>
<p>Stores each session attribute within a separate cache entry.
This is generally more efficient than SESSION granularity, but does not preserve any cross-attribute object references.</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">affinity</dt>
<dd>
<p>This resource defines the affinity that a web request should have for a given server.
The affinity of the associated web session determines the algorithm for generating the route to be appended onto the session ID (within the JSESSIONID cookie, or when encoding URLs).
This annotation of the session ID is used by load balancers to advise how future requests for existing sessions should be directed.
Routing is designed to be opaque to application code such that calls to <code>HttpSession.getId()</code> always return an unmodified session ID.
This is only generated when creating/updating the JSESSIONID cookie, or when encoding URLs via <code>HttpServletResponse.encodeURL()</code> and <code>encodeRedirectURL()</code>.
Possible values are:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">affinity=none</dt>
<dd>
<p>Web requests will have no affinity to any particular node.
This option is intended for use cases where web session state is not maintained within the application server.</p>
</dd>
<dt class="hdlist1">affinity=local</dt>
<dd>
<p>Web requests will have an affinity to the server that last handled a request for a given session.
This option corresponds to traditional sticky session behavior.</p>
</dd>
<dt class="hdlist1">affinity=primary-owner</dt>
<dd>
<p>Web requests will have an affinity to the primary owner of a given session.
This is the default affinity for this distributed session manager.
Behaves the same as affinity=local if the backing cache is not distributed nor replicated.</p>
</dd>
<dt class="hdlist1">affinity=ranked</dt>
<dd>
<p>Web requests will have an affinity to the first available node in a ranked list comprised of: primary owner, backup nodes, local node (if not a primary nor backup owner).
Only for use with load balancers that support multiple routes.
Behaves the same as affinity=local if cache is not distributed nor replicated.</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">marshaller</dt>
<dd>
<p>Specifies the marshalling implementation used to serialize session attributes.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">JBOSS</dt>
<dd>
<p>Marshals session attributes using <a href="#jboss_marshalling">JBoss Marshalling</a>.</p>
</dd>
<dt class="hdlist1">PROTOSTREAM</dt>
<dd>
<p>Marshals session attributes using <a href="#protostream">ProtoStream</a>.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>e.g. Creating a new session management profile, using ATTRIBUTE granularity with local session affinity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[standalone@embedded /] /subsystem=distributable-web/infinispan-session-management=foo:add(cache-container=web, granularity=ATTRIBUTE)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;
}
[standalone@embedded /] /subsystem=distributable-web/infinispan-session-management=foo/affinity=local:add(){allow-resource-service-restart=true}
{
    &quot;outcome&quot; =&gt; &quot;success&quot;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="hotrod-session-management"><a class="anchor" href="#hotrod-session-management"></a>2.1.2. HotRod session management</h4>
<div class="paragraph">
<p>The <code>hotrod-session-management</code> resource configures a distributable session manager where session data is stored in a remote infinispan-server cluster via the HotRod protocol.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">remote-cache-container</dt>
<dd>
<p>This references a <a href="#remote_cache_container">remote-cache-container</a> defined in the Infinispan subsystem into which session data will be stored.</p>
</dd>
<dt class="hdlist1">cache-configuration</dt>
<dd>
<p>If a remote cache whose name matches the deployment name does not exist, this attribute defines a cache configuration within the remote infinispan server, from which an application-specific cache will be created.</p>
</dd>
<dt class="hdlist1">granularity</dt>
<dd>
<p>This defines how the session manager will map a session into individual cache entries.
Possible values are:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">SESSION</dt>
<dd>
<p>Stores all session attributes within a single cache entry.
This is generally more expensive than ATTRIBUTE granularity, but preserves any cross-attribute object references.</p>
</dd>
<dt class="hdlist1">ATTRIBUTE</dt>
<dd>
<p>Stores each session attribute within a separate cache entry.
This is generally more efficient than SESSION granularity, but does not preserve any cross-attribute object references.</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">affinity</dt>
<dd>
<p>This resource defines the affinity that a web request should have for a given server.
The affinity of the associated web session determines the algorithm for generating the route to be appended onto the session ID (within the JSESSIONID cookie, or when encoding URLs).
This annotation of the session ID is used by load balancers to advise how future requests for existing sessions should be directed.
Routing is designed to be opaque to application code such that calls to <code>HttpSession.getId()</code> always return an unmodified session ID.
This is only generated when creating/updating the JSESSIONID cookie, or when encoding URLs via <code>HttpServletResponse.encodeURL()</code> and <code>encodeRedirectURL()</code>.
Possible values are:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">affinity=none</dt>
<dd>
<p>Web requests will have no affinity to any particular node.
This option is intended for use cases where web session state is not maintained within the application server.</p>
</dd>
<dt class="hdlist1">affinity=local</dt>
<dd>
<p>Web requests will have an affinity to the server that last handled a request for a given session.
This option corresponds to traditional sticky session behavior.</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">marshaller</dt>
<dd>
<p>Specifies the marshalling implementation used to serialize session attributes.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">JBOSS</dt>
<dd>
<p>Marshals session attributes using <a href="#jboss_marshalling">JBoss Marshalling</a>.</p>
</dd>
<dt class="hdlist1">PROTOSTREAM</dt>
<dd>
<p>Marshals session attributes using <a href="#protostream">ProtoStream</a>.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>e.g. Creating a new session management profile "foo" using the cache configuration "bar" defined on a remote infinispan server "datagrid" with ATTRIBUTE granularity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[standalone@embedded /] /subsystem=distributable-web/hotrod-session-management=foo:add(remote-cache-container=datagrid, cache-configuration=bar, granularity=ATTRIBUTE)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="overriding-default-behavior"><a class="anchor" href="#overriding-default-behavior"></a>2.2. Overriding default behavior</h3>
<div class="paragraph">
<p>A web application can override the default distributable session management behavior in 1 of 2 ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Reference a session-management profile by name</p>
</li>
<li>
<p>Provide deployment-specific session management configuration</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="referencing-an-existing-session-management-profile"><a class="anchor" href="#referencing-an-existing-session-management-profile"></a>2.2.1. Referencing an existing session management profile</h4>
<div class="paragraph">
<p>To use an existing distributed session management profile, a web application should include a distributable-web.xml deployment descriptor located within the application&#8217;s /WEB-INF directory.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="title">/WEB-INF/distributable-web.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;distributable-web</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:distributable-web:2.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;session-management</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/distributable-web&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the target distributed session management profile can be defined within an existing jboss-all.xml deployment descriptor:</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="title">/META-INF/jboss-all.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;jboss</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;distributable-web</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:distributable-web:2.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;session-management</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/distributable-web&gt;</span>
<span class="tag">&lt;/jboss&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-a-deployment-specific-session-management-profile"><a class="anchor" href="#using-a-deployment-specific-session-management-profile"></a>2.2.2. Using a deployment-specific session management profile</h4>
<div class="paragraph">
<p>If custom session management configuration will only be used by a single web application, you may find it more convenient to define the configuration within the deployment descriptor itself.
Ad hoc configuration looks identical to the configuration used by the distributable-web subsystem.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="title">/WEB-INF/distributable-web.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;distributable-web</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:distributable-web:2.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;infinispan-session-management</span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">granularity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SESSION</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;primary-owner-affinity</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/infinispan-session-management&gt;</span>
<span class="tag">&lt;/distributable-web&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, session management configuration can be defined within an existing jboss-all.xml deployment descriptor:</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="title">/META-INF/jboss-all.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;jboss</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;distributable-web</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:distributable-web:2.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;infinispan-session-management</span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">granularity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ATTRIBUTE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;local-affinity</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/infinispan-session-management&gt;</span>
    <span class="tag">&lt;/distributable-web&gt;</span>
<span class="tag">&lt;/jboss&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="distributable-shared-sessions"><a class="anchor" href="#distributable-shared-sessions"></a>2.3. Distributable Shared Sessions</h3>
<div class="paragraph">
<p>WildFly supports the ability to share sessions across web applications within an enterprise archive.
In previous releases, WildFly always presumed distributable session management of shared sessions.
Version 2.0 of the shared-session-config deployment descriptor was updated to allow an EAR to opt-in to this behavior using the familiar <code>&lt;distributable/&gt;</code> element.
Additionally, you can customize the behavior of the distributable session manager used for session sharing via the same configuration mechanism described in the above sections.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="title">/META-INF/jboss-all.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;jboss</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;shared-session-config</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:shared-session-config:2.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;distributable</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;session-config&gt;</span>
            <span class="tag">&lt;cookie-config&gt;</span>
                <span class="tag">&lt;path&gt;</span>/<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/cookie-config&gt;</span>
        <span class="tag">&lt;/session-config&gt;</span>
    <span class="tag">&lt;/shared-session-config&gt;</span>
    <span class="tag">&lt;distributable-web</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:distributable-web:2.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;session-management</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/distributable-web&gt;</span>
<span class="tag">&lt;/jboss&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="optimizing-performance-of-distributed-web-applications"><a class="anchor" href="#optimizing-performance-of-distributed-web-applications"></a>2.4. Optimizing performance of distributed web applications</h3>
<div class="paragraph">
<p>One of the primary design goals of WildFly&#8217;s distributed session manager was the parity of HttpSession semantics between distributable and non-distributable web applications.
In order to provide predictable behavior suitable for most web applications, the default distributed session manager configuration is quite conservative, generally favoring consistency over availability.
However, these defaults may not be appropriate for your application.
In general, the effective performance of the distributed session manager is constrained by:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Replication/persistence payload size</p>
</li>
<li>
<p>Locking/isolation of a given session</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To optimize the configuration of the distributed session manager for your application, you can address the above constraints by tuning one or more of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#session_granularity">Granularity</a></p>
</li>
<li>
<p><a href="#session_concurrency">Concurrency</a></p>
</li>
<li>
<p><a href="#session_attribute_immutability">Immutability</a></p>
</li>
<li>
<p><a href="#session_attribute_marshalling">Marshalling</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="session_granularity"><a class="anchor" href="#session_granularity"></a>2.4.1. Session granularity</h4>
<div class="paragraph">
<p>By default, WildFly&#8217;s distributed session manager uses SESSION granularity, meaning that all session attributes are stored within a single cache entry.
While this ensures that any object references shared between session attributes are preserved following replication/persistence, it means that a change to a single attribute results in the replication/persistence of <strong>all</strong> attributes.</p>
</div>
<div class="paragraph">
<p>If your application does not share any object references between attributes, users are strongly advised to use ATTRIBUTE granularity.
Using ATTRIBUTE granularity, each session attribute is stored in a separate cache entry.
This means that a given request is only required to replicate/persist those attributes that were added/modified/removed/mutated in a given request.
For read-heavy applications, this can dramatically reduce the replication/persistence payload per request.</p>
</div>
</div>
<div class="sect3">
<h4 id="session_concurrency"><a class="anchor" href="#session_concurrency"></a>2.4.2. Session concurrency</h4>
<div class="paragraph">
<p>WildFly&#8217;s default distributed session manager behavior is also conservative with respect to concurrent access to a given session.
By default, a request acquires exclusive access to its associated session for the duration of a request, and until any async child context is complete.
This maximizes the performance of a single request, as each request corresponds to a single cache transaction; allows for repeatable read semantics to the session; and ensures that subsequent requests are not prone to stale reads, even when handled by another cluster member.</p>
</div>
<div class="paragraph">
<p>However, if multiple requests attempt to access the same session concurrently, their processing will be effectively serialized.  This might not be feasible, especially for heavily asynchronous web applications.</p>
</div>
<div class="paragraph">
<p>Relaxing transaction isolation from REPEATABLE_READ to READ_COMMITTED on the associated cache configuration will allow concurrent requests to perform lock-free (but potentially stale) reads by deferring locking to the first attempt to write to the session.
This improves the throughput of requests for the same session for highly asynchronous web applications whose session access is read-heavy.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/subsystem=infinispan/cache-container=web/distributed-cache=dist/component=locking:write-attribute(name=isolation, value=READ_COMMITTED)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For asynchronous web applications whose session access is write-heavy, merely relaxing transaction isolation is not likely to be sufficient.
These web applications will likely benefit from disabling cache transactions altogether.
When transactions are disabled, cache entries are locked and released for every write to the session, resulting in last-write-wins semantics.
For write-heavy applications, this typically improves the throughput of concurrent requests for the same session, at the cost of longer response times for individual requests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/subsystem=infinispan/cache-container=web/distributed-cache=dist/component=transaction:write-attribute(name=mode, value=NONE)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Relaxing transaction isolation currently prevents WildFly from enforcing that a given session is handled by one JVM at a time, a constraint dictated by the servlet specification.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="session_attribute_immutability"><a class="anchor" href="#session_attribute_immutability"></a>2.4.3. Session attribute immutability</h4>
<div class="paragraph">
<p>In WildFly, distributed session attributes are presumed to be mutable objects, unless of a known immutable type, or unless otherwise specified.</p>
</div>
<div class="paragraph">
<p>Take the following session access pattern:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">HttpSession session = request.getSession();
MutableObject object = session.getAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>);
object.mutate();</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, WildFly replicates/persists the mutable session attributes at the end of the request, ensuring that a subsequent request will read the mutated value, not the original value.
However, the replication/persistence of mutable session attributes at the end of the request happens whether or not these objects were actually mutated.
To avoid redundant session writes, users are strongly encouraged to store immutable objects in the session whenever possible.
This allows the application more control over when session attributes will replicate/persist, since immutable session attributes will only update upon explicit calls to <code>HttpSession.setAttribute(&#8230;&#8203;)</code>.</p>
</div>
<div class="paragraph">
<p>WildFly can determine whether most JDK types are immutable, but any unrecognized/custom types are presumed to be mutable.
To indicate that a given session attribute of a custom type should be treated as immutable by the distributed session manager, annotate the class with one of the following annotations:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>@org.wildfly.clustering.web.annotation.Immutable</code></p>
</li>
<li>
<p><code>@net.jcip.annotations.Immutable</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Immutable</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ImmutableClass</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, immutable classes can be enumerated via the distributable-web deployment descriptor.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;distributable-web</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:distributable-web:2.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;session-management&gt;</span>
        <span class="tag">&lt;immutable-class&gt;</span>foo.bar.ImmutableClass<span class="tag">&lt;/immutable-class&gt;</span>
        <span class="tag">&lt;immutable-class&gt;</span>...<span class="tag">&lt;/immutable-class&gt;</span>
    <span class="tag">&lt;/session-management&gt;</span>
<span class="tag">&lt;/distributable-web&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="session_attribute_marshalling"><a class="anchor" href="#session_attribute_marshalling"></a>2.4.4. Session attribute marshalling</h4>
<div class="paragraph">
<p>Minimizing the replication/persistence payload for individual session attributes has a direct impact on performance by reducing the number of bytes sent over the network or persisted to storage.
See the <a href="#marshalling">Marshalling</a> section for more details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Distributable_Jakarta_Enterprise_Beans_Applications"><a class="anchor" href="#Distributable_Jakarta_Enterprise_Beans_Applications"></a>3. Distributable Jakarta Enterprise Beans Applications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Just as with standard web applications, session state of stateful session beans (SFSB) contained in a standard EJB application
is not guaranteed to survive beyond the lifespan of the Jakarta Enterprise Beans container. And, as with standard web applications, there <strong>is</strong> a way to
allow session state of SFSBs to survive beyond the lifespan of a single server, either through persistence or by replicating state to
other nodes in the cluster.</p>
</div>
<div class="paragraph">
<p>A <em>distributable</em> SFSB is one whose state is made available on multiple nodes in a cluster and which supports failover of invocation attempts: if the node
on which the SFSB was created fails, the invocation will be retried on another node in the cluster where the SFSB state is present.</p>
</div>
<div class="paragraph">
<p>In the case of Jakarta Enterprise Beans applications, whether or not a bean is distributable is determined globally or on a per-bean basis, rather than on
an application-wide basis as in the case of distributed HttpSessions.</p>
</div>
<div class="paragraph">
<p>A stateful session bean within an Jakarta Enterprise Beans application indicates its intention to be distributable by using a passivation-capable cache
to store its session state. Cache factories were discussed in the <a href="Admin_Guide.html#caches">Jakarta Enterprise Beans section of the Wildfly Admin Guide</a>.
Additionally, the EJB application needs to be deployed into a server which uses an High Availability (HA) server profile, such as standalone-ha.xml
or standalone-full-ha.xml.</p>
</div>
<div class="paragraph">
<p>Since Jakarta Enterprise Beans are passivation-capable by default, generally, users already using an HA profile will not need to make any configuration changes
for their beans to be distributable and, consequently, to support failover. More fine-grained control over whether a bean is distributable can be
achieved using the <em>passivationCapable</em> attribute of the @Stateful annotation (or the equivalent deployment descriptor override). A bean which is marked as
@Stateful(passivationCapable=false) will not exhibit distributable behavior (i.e. failover), even when the application containing it is deployed in a cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
More information on passivation-capable beans can be found in Section 4.6.5 of the Jakarta Enterprise Beans specification.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the sections that follow, we discuss some aspects of configuring distributable Jakarta Enterprise Beans applications in Wildfly.</p>
</div>
<div class="sect2">
<h3 id="distributable-ejb-subsystem"><a class="anchor" href="#distributable-ejb-subsystem"></a>3.1. Distributable EJB Subsystem</h3>
<div class="paragraph">
<p>The purpose of the distributable-ejb subsystem is to permit configuration of clustering abstractions
required to support those resources of the ejb3 subsystem which support clustered operation. The key resources
of the ejb3 subsystem which require clustering abstractions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cache factories</code>
Passivating cache factories depend on a bean management provider to provide passivation and persistence of SFSB
session states in a local or distributed environment.</p>
</li>
<li>
<p><code>client mappings registries</code>
Supporting remote invocation on SFSB deployed in a cluster require storing client mappings information in a
 client mappings registry. The registry may be tailored for a local or a distributed environment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These clustering abstractions are made available to the ejb3 subsystem via the specification and configuration of
clustering abstraction 'providers'. We describe the available providers below.</p>
</div>
<div class="sect3">
<h4 id="bean-management-providers"><a class="anchor" href="#bean-management-providers"></a>3.1.1. Bean management providers</h4>
<div class="paragraph">
<p>A bean management provider provides access to a given implementation of a bean manager,
used by passivation-capable cache factories defined in the ejb3 subsystem to manage passivation and persistence.</p>
</div>
<div class="paragraph">
<p>Bean management provider elements are named, and represent different implementation and configuration choices for bean management.
At least one named bean management provider must be defined in the distributable-ejb subsystem and of those, one
instance must be identified as the default bean management provider, using the <code>default-bean-management</code> attribute of
the distributable-ejb subsystem.</p>
</div>
<div class="paragraph">
<p>The available bean management provider is:</p>
</div>
<div class="sect4">
<h5 id="infinispan-bean-management"><a class="anchor" href="#infinispan-bean-management"></a>infinispan-bean-management</h5>
<div class="paragraph">
<p>The infinispan-bean-management provider element represents a bean manager implementation based on an Infinispan cache. The
attributes for the infinispan-bean-manager element are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">cache-container</dt>
<dd>
<p>Specifies a cache container defined in the Infinispan subsystem used to support the session state cache</p>
</dd>
<dt class="hdlist1">cache</dt>
<dd>
<p>Specifies the session state cache and its configured properties</p>
</dd>
<dt class="hdlist1">max-active-beans</dt>
<dd>
<p>Specifies the maximum number of non-passivated session state entries allowed in the cache</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="client-mappings-registries"><a class="anchor" href="#client-mappings-registries"></a>3.1.2. Client mappings registries</h4>
<div class="paragraph">
<p>A client mappings registry provider provides access to a given implementation of a client mappings registry, used by
the EJB client invocation mechanism to store information about client mappings for each node in the cluster. Client mappings
are defined in the socket bindings configuration of a server and required to allow an EJB client application to connect
to servers which are multi-homed (i.e. clients may access the same server from different networks using a different IP address
ad port for each interface on the multi-homed server).</p>
</div>
<div class="paragraph">
<p>The available client mappings registry providers are:</p>
</div>
<div class="sect4">
<h5 id="infinispan-client-mappings-registry"><a class="anchor" href="#infinispan-client-mappings-registry"></a>infinispan-client-mappings-registry</h5>
<div class="paragraph">
<p>The infinispan-client-mappings-registry provider is a provider based on an Infinispan cache and suitable for a clustered server.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">cache-container</dt>
<dd>
<p>Specifies a cache container defined in the Infinispan subsystem used to support the client mappings registry</p>
</dd>
<dt class="hdlist1">cache</dt>
<dd>
<p>Specifies the cache and its configured properties used to support the client mappings registry</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="local-client-mappings-registry"><a class="anchor" href="#local-client-mappings-registry"></a>local-client-mappings-registry</h5>
<div class="paragraph">
<p>The client mappings registry provider suitable for a local, non-clustered server.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="timer-management"><a class="anchor" href="#timer-management"></a>3.1.3. Timer management</h4>
<div class="paragraph">
<p>The distributable-ejb subsystem defines a set of timer management resources that define behavior for persistent or non-persistent EJB timers.</p>
</div>
<div class="paragraph">
<p>To use distributable timer management for EJB timers, one must first disable the existing in-memory mechanisms in the ejb3 subsystem.
See <a href="Developer_Guide.html#Jakarta_Enterprise_Beans_Distributed_Persistent_Timers">Jakarta Enterprise Beans Distributed Timer documentation</a> for details.</p>
</div>
<div class="sect4">
<h5 id="infinispan-timer-management"><a class="anchor" href="#infinispan-timer-management"></a>infinispan-timer-management</h5>
<div class="paragraph">
<p>This provider stores timer metadata within an embedded Infinispan cache, and utilizes consistent hashing to distribute timer execution between cluster members.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">cache-container</dt>
<dd>
<p>Specifies a cache container defined in the Infinispan subsystem</p>
</dd>
<dt class="hdlist1">cache</dt>
<dd>
<p>Specifies the a cache configuration within the specified cache-container</p>
</dd>
<dt class="hdlist1">max-active-timers</dt>
<dd>
<p>Specifies the maximum number active timers to retain in memory at a time, after which the least recently used will passivate</p>
</dd>
<dt class="hdlist1">marshaller</dt>
<dd>
<p>Specifies the marshalling implementation used to serialize the timeout context of a timer.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">JBOSS</dt>
<dd>
<p>Marshals session attributes using <a href="#jboss_marshalling">JBoss Marshalling</a>.</p>
</dd>
<dt class="hdlist1">PROTOSTREAM</dt>
<dd>
<p>Marshals session attributes using <a href="#protostream">ProtoStream</a>.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To ensure proper functioning, the associated cache configuration, regardless of type, should use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BATCH transaction mode</p>
</li>
<li>
<p>REPEATABLE_READ lock isolation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generally, persistent timers will leverage a distributed or replicated cache configuration if in a cluster, or a local, persistent cache configuration if on a single server;
while transient timers will leverage a local, passivating cache configuration.</p>
</div>
<div class="paragraph">
<p>By default, all cluster members will be eligible for timer execution.
A given cluster member exclude itself from timer execution by using a cache <code>capacity-factor</code> of 0.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploying-clustered-ejbs"><a class="anchor" href="#deploying-clustered-ejbs"></a>3.2. Deploying clustered EJBs</h3>
<div class="paragraph">
<p>Clustering support is available in the HA profiles of WildFly. In this
chapter we&#8217;ll be using the standalone server for explaining the details.
However, the same applies to servers in a domain mode. Starting the
standalone server with HA capabilities enabled, involves starting it
with the standalone-ha.xml (or even standalone-full-ha.xml):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./standalone.sh -server-config=standalone-ha.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will start a single instance of the server with HA capabilities.
Deploying the EJBs to this instance <em>doesn&#8217;t</em> involve anything special
and is the same as explained in the <a href="Admin_Guide.html#Application_deployment">application
deployment chapter</a>.</p>
</div>
<div class="paragraph">
<p>Obviously, to be able to see the benefits of clustering, you&#8217;ll need
more than one instance of the server. So let&#8217;s start another server with
HA capabilities. That another instance of the server can either be on
the same machine or on some other machine. If it&#8217;s on the same machine,
the two things you have to make sure is that you pass the port offset
for the second instance and also make sure that each of the server
instances have a unique <code>jboss.node.name</code> system property. You can do
that by passing the following two system properties to the startup
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./standalone.sh -server-config=standalone-ha.xml -Djboss.socket.binding.port-offset=&lt;offset of your choice&gt; -Djboss.node.name=&lt;unique node name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow whichever approach you feel comfortable with for deploying the
EJB deployment to this instance too.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Deploying the application on just one node of a standalone instance of a
clustered server does <strong>not</strong> mean that it will be automatically deployed
to the other clustered instance. You will have to do deploy it
explicitly on the other standalone clustered instance too. Or you can
start the servers in domain mode so that the deployment can be deployed
to all the server within a server group. See the
<a href="Admin_Guide.html">admin guide</a> for
more details on domain setup.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that you have deployed an application with clustered EJBs on both
the instances, the EJBs are now capable of making use of the clustering
features.</p>
</div>
<div class="sect3">
<h4 id="failover-for-clustered-ejbs"><a class="anchor" href="#failover-for-clustered-ejbs"></a>3.2.1. Failover for clustered EJBs</h4>
<div class="paragraph">
<p>Clustered EJBs have failover capability. The state of the @Stateful
@Clustered EJBs is replicated across the cluster nodes so that if one of
the nodes in the cluster goes down, some other node will be able to take
over the invocations. Let&#8217;s see how it&#8217;s implemented in WildFly. In
the next few sections we&#8217;ll see how it works for remote (standalone)
clients and for clients in another remote WildFly server instance.
Although, there isn&#8217;t a difference in how it works in both these cases,
we&#8217;ll still explain it separately so as to make sure there aren&#8217;t any
unanswered questions.</p>
</div>
</div>
<div class="sect3">
<h4 id="remote-standalone-clients"><a class="anchor" href="#remote-standalone-clients"></a>3.2.2. Remote standalone clients</h4>
<div class="paragraph">
<p>In this section we&#8217;ll consider a remote standalone client (i.e. a client
which runs in a separate JVM and <em>isn&#8217;t</em> running within another WildFly
8 instance). Let&#8217;s consider that we have 2 servers, server X and server
Y which we started earlier. Each of these servers has the clustered EJB
deployment. A standalone remote client can use either the
<a href="Developer_Guide.html#EJB_invocations_from_a_remote_client_using_JNDI">JNDI approach</a> or native JBoss EJB client APIs to
communicate with the servers. The important thing to note is that when
you are invoking clustered EJB deployments, you do <strong>not</strong> have to list
all the servers within the cluster (which obviously wouldn&#8217;t have been
feasible due the dynamic nature of cluster node additions within a
cluster).</p>
</div>
<div class="paragraph">
<p>The remote client just has to list only one of the servers with the
clustering capability. In this case, we can either list server X (in
<code>jboss-ejb-client.properties</code>) <em>or</em> server Y. This server will act as the
starting point for cluster topology communication between the client and
the clustered nodes.</p>
</div>
<div class="paragraph">
<p>Note that you have to configure the <em>ejb</em> cluster in the
jboss-ejb-client.properties configuration file, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>remote.clusters=ejb
remote.cluster.ejb.connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS=false
remote.cluster.ejb.connect.options.org.xnio.Options.SSL_ENABLED=false</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cluster-topology-communication"><a class="anchor" href="#cluster-topology-communication"></a>3.2.3. Cluster topology communication</h4>
<div class="paragraph">
<p>When a client connects to a server, the JBoss EJB client implementation
(internally) communicates with the server for cluster topology
information, if the server had clustering capability. In our example
above, let&#8217;s assume we listed server X as the initial server to connect
to. When the client connects to server X, the server will send back an
(asynchronous) cluster topology message to the client. This topology
message consists of the cluster name(s) and the information of the nodes
that belong to the cluster. The node information includes the node
address and port number to connect to (whenever necessary). So in this
example, the server X will send back the cluster topology consisting of
the other server Y which belongs to the cluster.</p>
</div>
<div class="paragraph">
<p>In case of stateful (clustered) EJBs, a typical invocation flow involves
creating of a session for the stateful bean, which happens when you do a
JNDI lookup for that bean, and then invoking on the returned proxy. The
lookup for stateful bean, internally, triggers a (synchronous) session
creation request from the client to the server. In this case, the
session creation request goes to server X since that&#8217;s the initial
connection that we have configured in our jboss-ejb-client.properties.
Since server X is clustered, it will return back a session id and along
with send back an <em>"affinity"</em> of that session. In case of clustered
servers, the affinity equals to the name of the cluster to which the
stateful bean belongs on the server side. For non-clustered beans, the
affinity is just the node name on which the session was created. This
<em>affinity</em> will later help the EJB client to route the invocations on
the proxy, appropriately to either a node within a cluster (for
clustered beans) or to a specific node (for non-clustered beans). While
this session creation request is going on, the server X will also send
back an asynchronous message which contains the cluster topology. The
JBoss EJB client implementation will take note of this topology
information and will later use it for connection creation to nodes
within the cluster and routing invocations to those nodes, whenever
necessary.</p>
</div>
<div class="paragraph">
<p>Now that we know how the cluster topology information is communicated
from the server to the client, let see how failover works. Let&#8217;s
continue with the example of server X being our starting point and a
client application looking up a stateful bean and invoking on it. During
these invocations, the client side will have collected the cluster
topology information from the server. Now let&#8217;s assume for some reason,
server X goes down and the client application subsequent invokes on the
proxy. The JBoss EJB client implementation, at this stage will be aware
of the affinity and in this case it&#8217;s a cluster affinity. Because of the
cluster topology information it has, it knows that the cluster has two
nodes server X and server Y. When the invocation now arrives, it sees
that the server X is down. So it uses a selector to fetch a suitable
node from among the cluster nodes. The selector itself is configurable,
but we&#8217;ll leave it from discussion for now. When the selector returns a
node from among the cluster, the JBoss EJB client implementation creates
a connection to that node (if not already created earlier) and creates a
EJB receiver out of it. Since in our example, the only other node in the
cluster is server Y, the selector will return that node and the JBoss
EJB client implementation will use it to create a EJB receiver out of it
and use that receiver to pass on the invocation on the proxy.
Effectively, the invocation has now failed over to a different node
within the cluster.</p>
</div>
</div>
<div class="sect3">
<h4 id="remote-clients-on-another-instance"><a class="anchor" href="#remote-clients-on-another-instance"></a>3.2.4. Remote clients on another instance of WildFly</h4>
<div class="paragraph">
<p>So far we discussed remote standalone clients which typically use either
the EJB client API or the jboss-ejb-client.properties based approach to
configure and communicate with the servers where the clustered beans are
deployed. Now let&#8217;s consider the case where the client is an application
deployed another AS7 instance and it wants to invoke on a clustered
stateful bean which is deployed on another instance of WildFly. In
this example let&#8217;s consider a case where we have 3 servers involved.
Server X and Server Y both belong to a cluster and have clustered EJB
deployed on them. Let&#8217;s consider another server instance Server C (which
may or may <em>not</em> have clustering capability) which acts as a client on
which there&#8217;s a deployment which wants to invoke on the clustered beans
deployed on server X and Y and achieve failover.</p>
</div>
<div class="paragraph">
<p>The configurations required to achieve this are explained in
<a href="Developer_Guide.html#EJB_invocations_from_a_remote_server_instance">this chapter</a>. As you can see the configurations are
done in a jboss-ejb-client.xml which points to a remote outbound
connection to the other server. This jboss-ejb-client.xml goes in the
deployment of server C (since that&#8217;s our client). As explained earlier,
the client configuration need <strong>not</strong> point to all clustered nodes.
Instead it just has to point to one of them which will act as a start
point for communication. So in this case, we can create a remote
outbound connection on server C to server X and use server X as our
starting point for communication. Just like in the case of remote
standalone clients, when the application on server C (client) looks up a
stateful bean, a session creation request will be sent to server X which
will send back a session id and the cluster affinity for it.
Furthermore, server X asynchronously send back a message to server C
(client) containing the cluster topology. This topology information will
include the node information of server Y (since that belongs to the
cluster along with server X). Subsequent invocations on the proxy will
be routed appropriately to the nodes in the cluster. If server X goes
down, as explained earlier, a different node from the cluster will be
selected and the invocation will be forwarded to that node.</p>
</div>
<div class="paragraph">
<p>As can be seen both remote standalone client and remote clients on
another WildFly instance act similar in terms of failover.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans (EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="messaging"><a class="anchor" href="#messaging"></a>4. Messaging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section is under development intending to describe high availability features and configuration pertaining to Jakarta Messaging (JMS).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="load-balancing"><a class="anchor" href="#load-balancing"></a>5. Load Balancing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mod_cluster_Subsystem"><a class="anchor" href="#mod_cluster_Subsystem"></a>5.1. mod_cluster Subsystem</h3>
<div class="paragraph">
<p>The mod_cluster integration is done via the <code>mod_cluster</code> subsystem.</p>
</div>
<div class="sect3">
<h4 id="mod_cluster_subsystem_configuration"><a class="anchor" href="#mod_cluster_subsystem_configuration"></a>5.1.1. Configuration</h4>
<div class="sect4">
<h5 id="instance-id-or-jvmroute"><a class="anchor" href="#instance-id-or-jvmroute"></a>Instance ID or JVMRoute</h5>
<div class="paragraph">
<p>The instance-id or JVMRoute defaults to <code>jboss.node.name</code> property passed
on server startup (e.g. via <code>-Djboss.node.name=XYZ</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=undertow:read-attribute(name=instance-id)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; expression &quot;${jboss.node.name}&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure instance-id statically, configure the corresponding
property in Undertow subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=undertow:write-attribute(name=instance-id,value=myroute)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;response-headers&quot; =&gt; {
        &quot;operation-requires-reload&quot; =&gt; true,
        &quot;process-state&quot; =&gt; &quot;reload-required&quot;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="proxies"><a class="anchor" href="#proxies"></a>Proxies</h5>
<div class="paragraph">
<p>By default, mod_cluster is configured for multicast-based discovery. To
specify a static list of proxies, create a remote-socket-binding for
each proxy and then reference them in the 'proxies' attribute. See the
following example for configuration in the domain mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[domain@localhost:9990 /] /socket-binding-group=ha-sockets/remote-destination-outbound-socket-binding=proxy1:add(host=10.21.152.86, port=6666)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; undefined,
    &quot;server-groups&quot; =&gt; undefined
}
[domain@localhost:9990 /] /socket-binding-group=ha-sockets/remote-destination-outbound-socket-binding=proxy2:add(host=10.21.152.87, port=6666)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; undefined,
    &quot;server-groups&quot; =&gt; undefined
}
[domain@localhost:9990 /] /profile=ha/subsystem=modcluster/proxy=default:write-attribute(name=proxies, value=[proxy1, proxy2])
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; undefined,
    &quot;server-groups&quot; =&gt; undefined
}
[domain@localhost:9990 /] :reload-servers
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; undefined,
    &quot;server-groups&quot; =&gt; undefined
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="multiple-mod_cluster-configurations"><a class="anchor" href="#multiple-mod_cluster-configurations"></a>Multiple mod_cluster Configurations</h5>
<div class="paragraph">
<p>Since WildFly 14 mod_cluster subsystem supports multiple named proxy configurations also allowing for registering
non-default Undertow servers with the reverse proxies. Moreover, this allows single application server node to register with
different groups of proxy servers.</p>
</div>
<div class="paragraph">
<p>See the following example which adds another Undertow AJP listener, server and a host and adds a new mod_cluster configuration
which registers this host using advertise mechanism.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/socket-binding-group=standard-sockets/socket-binding=ajp-other:add(port=8010)
/subsystem=undertow/server=other-server:add
/subsystem=undertow/server=other-server/ajp-listener=ajp-other:add(socket-binding=ajp-other)
/subsystem=undertow/server=other-server/host=other-host:add(default-web-module=root-other.war)
/subsystem=undertow/server=other-server/host=other-host/location=other:add(handler=welcome-content)
/subsystem=undertow/server=other-server/host=other-host:write-attribute(name=alias,value=[localhost]))

/socket-binding-group=standard-sockets/socket-binding=modcluster-other:add(multicast-address=224.0.1.106,multicast-port=23364)
/subsystem=modcluster/proxy=other:add(advertise-socket=modcluster-other,balancer=other-balancer,connector=ajp-other)

reload</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="runtime-operations"><a class="anchor" href="#runtime-operations"></a>5.1.2. Runtime Operations</h4>
<div class="paragraph">
<p>The modcluster subsystem supports several operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:read-operation-names
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; [
        &quot;add&quot;,
        &quot;add-custom-metric&quot;,
        &quot;add-metric&quot;,
        &quot;add-proxy&quot;,
        &quot;disable&quot;,
        &quot;disable-context&quot;,
        &quot;enable&quot;,
        &quot;enable-context&quot;,
        &quot;list-proxies&quot;,
        &quot;read-attribute&quot;,
        &quot;read-children-names&quot;,
        &quot;read-children-resources&quot;,
        &quot;read-children-types&quot;,
        &quot;read-operation-description&quot;,
        &quot;read-operation-names&quot;,
        &quot;read-proxies-configuration&quot;,
        &quot;read-proxies-info&quot;,
        &quot;read-resource&quot;,
        &quot;read-resource-description&quot;,
        &quot;refresh&quot;,
        &quot;remove-custom-metric&quot;,
        &quot;remove-metric&quot;,
        &quot;remove-proxy&quot;,
        &quot;reset&quot;,
        &quot;stop&quot;,
        &quot;stop-context&quot;,
        &quot;validate-address&quot;,
        &quot;write-attribute&quot;
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The operations specific to the modcluster subsystem are divided in 3
categories the ones that affects the configuration and require a restart
of the subsystem, the one that just modify the behaviour temporarily and
the ones that display information from the httpd part.</p>
</div>
<div class="sect4">
<h5 id="operations-displaying-httpd-informations"><a class="anchor" href="#operations-displaying-httpd-informations"></a>operations displaying httpd information</h5>
<div class="paragraph">
<p>There are 2 operations that display how Apache httpd sees the node:</p>
</div>
<div class="sect5">
<h6 id="read-proxies-configuration"><a class="anchor" href="#read-proxies-configuration"></a>read-proxies-configuration</h6>
<div class="paragraph">
<p>Send a DUMP message to all Apache httpd the node is connected to and
display the message received from Apache httpd.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:read-proxies-configuration
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; [
        &quot;neo3:6666&quot;,
        &quot;balancer: [1] Name: mycluster Sticky: 1 [JSESSIONID]/[jsessionid] remove: 0 force: 1 Timeout: 0 Maxtry: 1
node: [1:1],Balancer: mycluster,JVMRoute: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,Domain: [],Host: 127.0.0.1,Port: 8080,Type: http,flushpackets: 0,flushwait: 10,ping: 10,smax: 26,ttl: 60,timeout: 0
host: 1 [example.com] vhost: 1 node: 1
host: 2 [localhost] vhost: 1 node: 1
host: 3 [default-host] vhost: 1 node: 1
context: 1 [/myapp] vhost: 1 node: 1 status: 1
context: 2 [/] vhost: 1 node: 1 status: 1
&quot;,
        &quot;jfcpc:6666&quot;,
        &quot;balancer: [1] Name: mycluster Sticky: 1 [JSESSIONID]/[jsessionid] remove: 0 force: 1 Timeout: 0 maxAttempts: 1
node: [1:1],Balancer: mycluster,JVMRoute: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,LBGroup: [],Host: 127.0.0.1,Port: 8080,Type: http,flushpackets: 0,flushwait: 10,ping: 10,smax: 26,ttl: 60,timeout: 0
host: 1 [default-host] vhost: 1 node: 1
host: 2 [localhost] vhost: 1 node: 1
host: 3 [example.com] vhost: 1 node: 1
context: 1 [/] vhost: 1 node: 1 status: 1
context: 2 [/myapp] vhost: 1 node: 1 status: 1
&quot;
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="read-proxies-info"><a class="anchor" href="#read-proxies-info"></a>read-proxies-info</h6>
<div class="paragraph">
<p>Send a INFO message to all Apache httpd the node is connected to and
display the message received from Apache httpd.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:read-proxies-info
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; [
        &quot;neo3:6666&quot;,
        &quot;Node: [1],Name: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,Balancer: mycluster,Domain: ,Host: 127.0.0.1,Port: 8080,Type: http,Flushpackets: Off,Flushwait: 10000,Ping: 10000000,Smax: 26,Ttl: 60000000,Elected: 0,Read: 0,Transfered: 0,Connected: 0,Load: -1
Vhost: [1:1:1], Alias: example.com
Vhost: [1:1:2], Alias: localhost
Vhost: [1:1:3], Alias: default-host
Context: [1:1:1], Context: /myapp, Status: ENABLED
Context: [1:1:2], Context: /, Status: ENABLED
&quot;,
        &quot;jfcpc:6666&quot;,
        &quot;Node: [1],Name: 498bb1f0-00d9-3436-a341-7f012bc2e7ec,Balancer: mycluster,LBGroup: ,Host: 127.0.0.1,Port: 8080,Type: http,Flushpackets: Off,Flushwait: 10,Ping: 10,Smax: 26,Ttl: 60,Elected: 0,Read: 0,Transfered: 0,Connected: 0,Load: 1
Vhost: [1:1:1], Alias: default-host
Vhost: [1:1:2], Alias: localhost
Vhost: [1:1:3], Alias: example.com
Context: [1:1:1], Context: /, Status: ENABLED
Context: [1:1:2], Context: /myapp, Status: ENABLED
&quot;
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="operations-that-handle-the-proxies-the-node-is-connected-too"><a class="anchor" href="#operations-that-handle-the-proxies-the-node-is-connected-too"></a>operations that handle the proxies the node is connected too</h6>
<div class="paragraph">
<p>There are 3 operation that could be used to manipulate the list of
Apache httpd the node is connected to.</p>
</div>
</div>
<div class="sect5">
<h6 id="list-proxies"><a class="anchor" href="#list-proxies"></a>list-proxies</h6>
<div class="paragraph">
<p>Displays the httpd that are connected to the node. The httpd could be
discovered via the Advertise protocol or via the proxy-list attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 subsystem=modcluster] :list-proxies
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; [
        &quot;proxy1:6666&quot;,
        &quot;proxy2:6666&quot;
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="remove-proxy"><a class="anchor" href="#remove-proxy"></a>remove-proxy</h6>
<div class="paragraph">
<p>Remove a proxy from the discovered proxies or temporarily from the
proxy-list attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 subsystem=modcluster] :remove-proxy(host=jfcpc, port=6666)
{&quot;outcome&quot; =&gt; &quot;success&quot;}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="add-proxy"><a class="anchor" href="#add-proxy"></a>add-proxy</h6>
<div class="paragraph">
<p>Add a proxy to the discovered proxies or temporarily to the proxy-list
attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 subsystem=modcluster] :add-proxy(host=jfcpc, port=6666)
{&quot;outcome&quot; =&gt; &quot;success&quot;}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="context-related-operations"><a class="anchor" href="#context-related-operations"></a>Context related operations</h5>
<div class="paragraph">
<p>Those operations allow to send context related commands to Apache httpd.
They are send automatically when deploying or undeploying webapps.</p>
</div>
<div class="sect5">
<h6 id="enable-context"><a class="anchor" href="#enable-context"></a>enable-context</h6>
<div class="paragraph">
<p>Tell Apache httpd that the context is ready receive requests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:enable-context(context=/myapp, virtualhost=default-host)
{&quot;outcome&quot; =&gt; &quot;success&quot;}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="disable-context"><a class="anchor" href="#disable-context"></a>disable-context</h6>
<div class="paragraph">
<p>Tell Apache httpd that it shouldn&#8217;t send new session requests to the
context of the virtualhost.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:disable-context(context=/myapp, virtualhost=default-host)
{&quot;outcome&quot; =&gt; &quot;success&quot;}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="stop-context"><a class="anchor" href="#stop-context"></a>stop-context</h6>
<div class="paragraph">
<p>Tell Apache httpd that it shouldn&#8217;t send requests to the context of the
virtualhost.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:stop-context(context=/myapp, virtualhost=default-host, waittime=50)
{&quot;outcome&quot; =&gt; &quot;success&quot;}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="node-related-operations"><a class="anchor" href="#node-related-operations"></a>Node related operations</h5>
<div class="paragraph">
<p>Those operations are like the context operation but they apply to all
webapps running on the node and operation that affect the whole node.</p>
</div>
<div class="sect5">
<h6 id="refresh"><a class="anchor" href="#refresh"></a>refresh</h6>
<div class="paragraph">
<p>Refresh the node by sending a new CONFIG message to Apache httpd.</p>
</div>
</div>
<div class="sect5">
<h6 id="reset"><a class="anchor" href="#reset"></a>reset</h6>
<div class="paragraph">
<p>Reset the connection between Apache httpd and the node.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuration-1"><a class="anchor" href="#configuration-1"></a>Configuration</h5>
<div class="sect5">
<h6 id="metric-configuration"><a class="anchor" href="#metric-configuration"></a>Metric configuration</h6>
<div class="paragraph">
<p>There are 4 metric operations corresponding to add and remove load
metrics to the dynamic-load-provider. Note that when nothing is defined
a simple-load-provider is use with a fixed load factor of one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:read-resource(name=mod-cluster-config)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; {&quot;simple-load-provider&quot; =&gt; {&quot;factor&quot; =&gt; &quot;1&quot;}}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>that corresponds to the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:modcluster:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;mod-cluster-config&gt;</span>
                <span class="tag">&lt;simple-load-provider</span> <span class="attribute-name">factor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/mod-cluster-config&gt;</span>
 <span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="sect6">
<h7 id="add-metric"><a class="anchor" href="#add-metric"></a>add-metric</h7>
<div class="paragraph">
<p>Add a metric to the dynamic-load-provider, the dynamic-load-provider in
configuration is created if needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:add-metric(type=cpu)
{&quot;outcome&quot; =&gt; &quot;success&quot;}
[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:read-resource(name=mod-cluster-config)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; {
        &quot;dynamic-load-provider&quot; =&gt; {
            &quot;history&quot; =&gt; 9,
            &quot;decay&quot; =&gt; 2,
            &quot;load-metric&quot; =&gt; [{
                &quot;type&quot; =&gt; &quot;cpu&quot;
            }]
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="remove-metric"><a class="anchor" href="#remove-metric"></a>remove-metric</h7>
<div class="paragraph">
<p>Remove a metric from the dynamic-load-provider.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:remove-metric(type=cpu)
{&quot;outcome&quot; =&gt; &quot;success&quot;}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="add-custom-metric-remove-custom-metric"><a class="anchor" href="#add-custom-metric-remove-custom-metric"></a>add-custom-metric / remove-custom-metric</h7>
<div class="paragraph">
<p>like the add-metric and remove-metric except they require a class
parameter instead the type. Usually they needed additional properties
which can be specified</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=modcluster/proxy=default:add-custom-metric(class=myclass, property=[(&quot;pro1&quot; =&gt; &quot;value1&quot;), (&quot;pro2&quot; =&gt; &quot;value2&quot;)]
{&quot;outcome&quot; =&gt; &quot;success&quot;}</code></pre>
</div>
</div>
<div class="paragraph">
<p>which corresponds the following in the xml configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:modcluster:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;mod-cluster-config&gt;</span>
        <span class="tag">&lt;dynamic-load-provider</span> <span class="attribute-name">history</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">9</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">decay</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;custom-load-metric</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myclass</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pro1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pro2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/custom-load-metric&gt;</span>
        <span class="tag">&lt;/dynamic-load-provider&gt;</span>
    <span class="tag">&lt;/mod-cluster-config&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="SSL_Configuration_using_Elytron_Subsystem"><a class="anchor" href="#SSL_Configuration_using_Elytron_Subsystem"></a>5.1.3. SSL Configuration using Elytron Subsystem</h4>
<div class="quoteblock abstract">
<blockquote>
This section provides information how to configure mod_cluster
subsystem to protect communication between mod_cluster and load balancer
using SSL/TLS using <a href="WildFly_Elytron_Security.html#Elytron_Subsystem">Elytron Subsystem</a>.
</blockquote>
</div>
<div class="sect4">
<h5 id="overview"><a class="anchor" href="#overview"></a>Overview</h5>
<div class="paragraph">
<p>Elytron subsystem provides a powerful and flexible model to configure
different security aspects for applications and the application server
itself. At its core, Elytron subsystem exposes different capabilities to
the application server in order centralize security related
configuration in a single place and to allow other subsystems to consume
these capabilities. One of the security capabilities exposed by Elytron
subsystem is a Client <code>ssl-context</code> that can be used to configure
mod_cluster subsystem to communicate with a load balancer using SSL/TLS.</p>
</div>
<div class="paragraph">
<p>When protecting the communication between the application server and the
load balancer, you need do define a Client <code>ssl-context</code> in order to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define a trust store holding the certificate chain that will be used
to validate load balancer&#8217;s certificate</p>
</li>
<li>
<p>Define a trust manager to perform validations against the load
balancer&#8217;s certificate</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="defining-a-trust-store-with-the-trusted-certificates"><a class="anchor" href="#defining-a-trust-store-with-the-trusted-certificates"></a>Defining a Trust Store with the Trusted Certificates</h5>
<div class="paragraph">
<p>To define a trust store in Elytron you can execute the following CLI
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=elytron/key-store=default-trust-store:add(type=PKCS12, relative-to=jboss.server.config.dir, path=application.truststore, credential-reference={clear-text=password})</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to successfully execute the command above you must have a
<strong>application.truststore</strong> file inside your
<strong>JBOSS_HOME/standalone/configuration</strong> directory. Where the trust store
is protected by a password with a value <strong>password</strong>. The trust store must
contain the certificates associated with the load balancer or a
certificate chain in case the load balancer&#8217;s certificate is signed by a
CA.</p>
</div>
<div class="paragraph">
<p>We strongly recommend you to avoid using self-signed certificates with
your load balancer. Ideally, certificates should be signed by a CA and
your trust store should contain a certificate chain representing your
ROOT and Intermediary CAs.</p>
</div>
</div>
<div class="sect4">
<h5 id="defining-a-trust-manager-to-validate-certificates"><a class="anchor" href="#defining-a-trust-manager-to-validate-certificates"></a>Defining a Trust Manager To Validate Certificates</h5>
<div class="paragraph">
<p>To define a trust manager in Elytron you can execute the following CLI
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=elytron/trust-manager=default-trust-manager:add(algorithm=PKIX, key-store=default-trust-store)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we are setting the <strong>default-trust-store</strong> as the source of the
certificates that the application server trusts.</p>
</div>
</div>
<div class="sect4">
<h5 id="defining-a-client-ssl-context-and-configuring-mod_cluster-subsystem"><a class="anchor" href="#defining-a-client-ssl-context-and-configuring-mod_cluster-subsystem"></a>Defining a Client SSL Context and Configuring mod_cluster Subsystem</h5>
<div class="paragraph">
<p>Finally, you can create the Client SSL Context that is going to be used
by the mod_cluster subsystem when connecting to the load balancer using
SSL/TLS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=elytron/client-ssl-context=modcluster-client:add(trust-manager=default-trust-manager)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that the Client <code>ssl-context</code> is defined you can configure
mod_cluster subsystem as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=modcluster/proxy=default:write-attribute(name=ssl-context, value=modcluster-client)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you execute the last command above, reload the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>reload</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="using-a-certificate-revocation-list"><a class="anchor" href="#using-a-certificate-revocation-list"></a>Using a Certificate Revocation List</h5>
<div class="paragraph">
<p>In case you want to validate the load balancer certificate against a
Certificate Revocation List (CRL), you can configure the <code>trust-manager</code>
in Elytron subsystem as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=elytron/trust-manager=default-trust-manager:write-attribute(name=certificate-revocation-list.path, value=intermediate.crl.pem)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use a CRL your trust store must contain the certificate chain in
order to check validity of both CRL list and the load balancer`s
certificate.</p>
</div>
<div class="paragraph">
<p>A different way to configure a CRL is using the <em>Distribution Points</em>
embedded in your certificates. For that, you need to configure a
<code>certificate-revocation-list</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=elytron/trust-manager=default-trust-manager:write-attribute(name=certificate-revocation-list)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="remote-user-authentication-with-elytron"><a class="anchor" href="#remote-user-authentication-with-elytron"></a>5.1.4. Remote User Authentication with Elytron</h4>
<div class="paragraph">
<p>It is possible to accept a <code>REMOTE_USER</code> already authenticated by the Apache httpd server with Elytron via the AJP protocol.
This can be done by setting up Elytron to secure a WildFly deployment and specifying for the External HTTP mechanism to
be used. This is done by creating a security domain and specifying the External mechanism as one of the mechanism
configurations to be used by the <code>http-authentication-factory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/subsystem=elytron/http-authentication-factory=web-tests:add(security-domain=example-domain, http-server-mechanism-factory=example-factory,
mechanism-configurations=[{mechanism-name=EXTERNAL}])</pre>
</div>
</div>
<div class="paragraph">
<p>Elytron will accept the externally authenticated user and use the specified security domain to perform role mapping to
complete authorization.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ranked-affinity-load-balancer"><a class="anchor" href="#ranked-affinity-load-balancer"></a>5.2. Enabling ranked affinity support in load balancer</h3>
<div class="paragraph">
<p>Enabling ranked affinity support in the <a href="#distributable-web-subsystem">server</a> must be accompanied by a compatible load balancer with ranked affinity support enabled.
When using WildFly as a load balancer ranked routing can be enabled with the following CLI command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=undertow/configuration=filter/mod-cluster=load-balancer/affinity=ranked:add</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default delimiter which delimiters the node routes is "." which encodes multiple routes as <code>node1.node2.node3</code>.
Should the delimiter be required to be different, this is configurable by the <code>delimiter</code> attribute of the <code>affinity</code> resource.
See the following CLI command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=undertow/configuration=filter/mod-cluster=load-balancer/affinity=ranked:write-attribute(name=delimiter,value=&quot;:&quot;)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="load-balancer-affinity-cookie"><a class="anchor" href="#load-balancer-affinity-cookie"></a>5.3. Support for load-balancers relying on affinity cookie</h3>
<div class="paragraph">
<p>While the Apache family of load-balancers relies on attaching session affinity (routing) information by default to a <code>JSESSIONID</code> cookie or a <code>jsessionid</code> path parameter,
there are other load-balancers that rely on a cookie to drive session affinity.</p>
</div>
<div class="paragraph">
<p>In order to configure the cookie name and other properties use the following CLI script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=undertow/servlet-container=default/setting=affinity-cookie:add(name=SRV)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The affinity can be specified either in the <code>instance-id</code> or by providing <code>jboss.node.name</code> property to the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>./bin/standalone.sh -c standalone-ha.xml -Djboss.node.name=ribera1</code></pre>
</div>
</div>
<div class="paragraph">
<p>For complete documentation on configuring the servlet container refer to <a href="Admin_Guide.html#servlet-container-configuration">Undertow documentation section</a>.</p>
</div>
<div class="sect3">
<h4 id="haproxy"><a class="anchor" href="#haproxy"></a>5.3.1. HAProxy</h4>
<div class="paragraph">
<p>The following is a minimum HAProxy configuration to enable affinity provided by application server to be respected by the given load-balancer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>defaults
timeout connect 5s
timeout client 50s
timeout server 50s

frontend myfrontend
bind 127.0.0.1:8888
default_backend myservers

backend myservers
mode http
cookie SRV indirect preserve
option redispatch
server server1 127.0.0.1:8080 cookie ribera1
server server2 127.0.0.1:8180 cookie ribera2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the proxy server defined cookie names need to correspond with the application server&#8217;s <code>instance-id</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustering-in-the-cloud"><a class="anchor" href="#clustering-in-the-cloud"></a>6. Clustering in the Cloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section of the documentation describes topics relating to the deploying and running in a cloud environment.</p>
</div>
<div class="sect2">
<h3 id="kubernetes"><a class="anchor" href="#kubernetes"></a>6.1. Kubernetes</h3>
<div class="paragraph">
<p>Kubernetes is an ideal environment for deploying and running highly available services.
This section describes the specifics of deploying HA applications built on WildFly in this cloud environment.</p>
</div>
<div class="sect3">
<h4 id="role-of-the-distributed-cache-mode"><a class="anchor" href="#role-of-the-distributed-cache-mode"></a>6.1.1. Role of the Distributed Cache Mode</h4>
<div class="paragraph">
<p>WildFly uses <a href="#infinispan">Infinispan</a> to provide high-availability of server-side state.
While there are multiple cache modes available, the 'distributed-cache' cache is optimal for cloud environments.
This cache mode stores data in a configurable number of cluster members (defaults to <code>2</code>),
and thus allows users to elect the desired balance between availability and capacity.
The higher the number of owners, the greater availability (i.e. tolerance to failures), but reduces the effective heap capacity of the cluster.
There is a marginal network cost associated with more owners, but this is a secondary concern.</p>
</div>
<div class="paragraph">
<p>This cache mode relies on consistent hashing to determine the 'primary owner' and the 'backup owners' of given cache entries.
In order to achieve optimal performance, the load balancer deployed in front of the application server cluster:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>should route HTTP requests for a given session to the current primary owner,</p>
</li>
<li>
<p>as the cluster topology changes, in response to scaling or failures, Infinispan will rebalance its distributed session state in response.
To ensure optimal performance, the application server must be able to influence the session affinity decisions made by the load balancer such that subsequent requests for a given are routed to the preferred pod.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This can be achieved by configuring HAProxy Ingress Controller described below.</p>
</div>
<div class="sect4">
<h5 id="changing-cache-mode-in-deployment-image"><a class="anchor" href="#changing-cache-mode-in-deployment-image"></a>Changing Cache Mode in Deployment Image</h5>
<div class="paragraph">
<p>Presently, the default configuration currently uses replicated caches.
This effectively fixes the heap capability of the cluster such that it cannot be increased by scaling up.
Thus, existing applications need to update the default cache mode to optimize scalability.</p>
</div>
<div class="paragraph">
<p>Applications built using Maven with <a href="https://docs.wildfly.org/wildfly-maven-plugin/releases/4.2/package-mojo.html#packagingScripts">WildFly Maven Plugin</a>
to create an image can be easily configured to update the default cache mode.
This can be done by configuring a set of commands in the packaging step to reconfigure the bundled server.
The following <code>infinispan.cli</code> configuration script will reconfigure the <code>infinispan</code> subsystem to use the distributed cache for web sessions:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.cli</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cli">/subsystem=infinispan/cache-container=web/distributed-cache=sessions:add
/subsystem=infinispan/cache-container=web/distributed-cache=sessions/component=expiration:add(interval=0)
/subsystem=infinispan/cache-container=web:write-attribute(name=default-cache,value=sessions)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Maven plugin configuration can then be updated to update the generated container image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.wildfly.plugins<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>wildfly-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;executions&gt;</span>
        <span class="tag">&lt;execution&gt;</span>
            <span class="comment">&lt;!-- ... --&gt;</span>
            <span class="tag">&lt;configuration&gt;</span>
                <span class="comment">&lt;!-- ... --&gt;</span>
                <span class="tag">&lt;packaging-scripts&gt;</span>
                    <span class="tag">&lt;packaging-script&gt;</span>
                        <span class="tag">&lt;script</span><span class="attribute-name">s</span><span class="tag">&gt;</span>
<span class="inline">                            &lt;script&gt;infinispan.cli</span><span class="tag">&lt;/script&gt;</span>
                        <span class="tag">&lt;/scripts&gt;</span>
                    <span class="tag">&lt;/packaging-script&gt;</span>
                <span class="tag">&lt;/packaging-scripts&gt;</span>
            <span class="tag">&lt;/configuration&gt;</span>
        <span class="tag">&lt;/execution&gt;</span>
    <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ingress-configuration"><a class="anchor" href="#ingress-configuration"></a>6.1.2. Ingress Configuration</h4>
<div class="paragraph">
<p>A <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Kubernetes Ingress</a> is an object that manages external access to the services in a cluster, typically via HTTP.
It provides load balancing, SSL termination and name-based virtual hosting.
In order to support the affinity requirements described above, an Ingress Controller implementation, supporting L7 load balancing and exposes the requisite annotations for configuring session affinity, will need to be configured.
The following sections will configure an <a href="https://haproxy-ingress.github.io/">HAProxy Ingress Controller</a> for optimal routing.</p>
</div>
<div class="sect4">
<h5 id="configuring-affinity-in-deployment-image"><a class="anchor" href="#configuring-affinity-in-deployment-image"></a>Configuring Affinity in Deployment Image</h5>
<div class="paragraph">
<p>First, we will need to reconfigure the application server to store the affinity information in a separate cookie.
By default, WildFly encodes session affinity information in the <code>JSESSIONID</code> cookie value, which is already used to uniquely identify a session.
While this works well with the httpd family of load balancer modules (e.g. mod_cluster, mod_proxy_balancer, mod_jk) for which this mechanism was designed,
the current set of load balancers used in the cloud rely on a separate cookie for implementing sticky sessions (e.g. HAProxy),
and thus the default WildFly configuration lacks the ability to allow WildFly to guide requests for a given session to the server that can most efficiently handle it.
To resolve this, we need to configure the Undertow subsystem to use a separate cookie to send affinity information.
For configured distribution or replication mode caches, the load balancer needs to be made aware of the affinity.
As the topology of the cluster changes, the affinity will need to be updated.</p>
</div>
<div class="paragraph">
<p>The following <code>undertow.cli</code> configuration script will reconfigure the <code>undertow</code> subsystem to use a separate cookie named <code>INGRESSCOOKIE</code> to store the affinity information:</p>
</div>
<div class="listingblock">
<div class="title">undertow.cli</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cli">/subsystem=undertow/servlet-container=default/setting=affinity-cookie:add(name=INGRESSCOOKIE)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="installing-haproxy-ingress-controller"><a class="anchor" href="#installing-haproxy-ingress-controller"></a>Installing HAProxy Ingress Controller</h5>
<div class="paragraph">
<p>The HAProxy Ingress Controller can be installed using <a href="https://helm.sh/">Helm</a>. First add the required repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ helm repo add haproxy-ingress https://haproxy-ingress.github.io/charts
&quot;haproxy-ingress&quot; has been added to your repositories</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, the Ingress Controller can be installed to the Kubernetes cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ helm install haproxy-ingress haproxy-ingress/haproxy-ingress --create-namespace --namespace=ingress-controller
NAME: haproxy-ingress
LAST DEPLOYED: Tue Nov 14 16:18:10 2023
NAMESPACE: ingress-controller
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
HAProxy Ingress has been installed!

HAProxy is exposed as a `LoadBalancer` type service.
It may take a few minutes for the LoadBalancer IP to be available.
You can watch the status by running:

    kubectl --namespace ingress-controller get services haproxy-ingress -o wide -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the controller is available in the Kubernetes cluster, we can configure an Ingress object.</p>
</div>
</div>
<div class="sect4">
<h5 id="configuring-an-ingress"><a class="anchor" href="#configuring-an-ingress"></a>Configuring an Ingress</h5>
<div class="paragraph">
<p>The following Ingress configuration can be used for optimal handling of session affinity.
Note that the name of the ingress, hosts, and the service name needs to be updated to actual values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">networking.k8s.io/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Ingress</span></span>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">example-ingress</span></span>
  <span class="key">namespace</span>: <span class="string"><span class="content">default</span></span>
  <span class="key">annotations</span>:
    <span class="key">haproxy-ingress.github.io/affinity</span>: <span class="string"><span class="content">cookie </span></span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">haproxy-ingress.github.io/backend-server-naming</span>: <span class="string"><span class="content">pod </span></span><i class="conum" data-value="2"></i><b>(2)</b>
    <span class="key">haproxy-ingress.github.io/session-cookie-dynamic</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="key">haproxy-ingress.github.io/session-cookie-keywords</span>: <span class="string"><span class="content">preserve </span></span><i class="conum" data-value="4"></i><b>(4)</b>
    <span class="key">haproxy-ingress.github.io/session-cookie-preserve</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="5"></i><b>(5)</b>
<span class="key">spec</span>:
  <span class="key">ingressClassName</span>: <span class="string"><span class="content">haproxy</span></span>
  <span class="key">tls</span>:
    - <span class="string"><span class="content">hosts:</span><span class="content">
        - example.com</span></span>
  <span class="key">rules</span>:
    - <span class="string"><span class="content">host: example.com</span></span>
      <span class="key">http</span>:
        <span class="key">paths</span>:
          - <span class="string"><span class="content">path: /</span></span>
            <span class="key">pathType</span>: <span class="string"><span class="content">Prefix</span></span>
            <span class="key">backend</span>:
              <span class="key">service</span>:
                <span class="key">name</span>: <span class="string"><span class="content">example-service</span></span>
                <span class="key">port</span>:
                  <span class="key">number</span>: <span class="string"><span class="content">8080</span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use a cookie to store the affinity.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the pod&#8217;s unique name as the backend server identity. This allows WildFly to update the existing affinity.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Instructs the proxy to use a predictable backend server name.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configures preserving cookies as additional options for handling cookies.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Prevent HAProxy from overwriting the <code>Set-Cookie</code> header written by the backend server.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="verifying-session-affinity"><a class="anchor" href="#verifying-session-affinity"></a>6.1.3. Verifying Session Affinity</h4>
<div class="paragraph">
<p>Verifying session affinity has proven to be notoriously challenging for users.
This is primarily because, even if the affinity handling is not set up optimally,
the tester will not observe any data loss in a distributed HA application.
If a request for a given HTTP session is routed to a pod that does not contain the requested session data locally,
it will remotely fetch the session data from another pod.
While this does not affect functionality per se, this has implications for performance, response time, concurrency, consistency, etc.</p>
</div>
<div class="paragraph">
<p>The following is a simple guide how to verify correctly functioning session affinity.</p>
</div>
<div class="paragraph">
<p>First, configure the Undertow web server to attach information about which cluster node actually processed the request.
This can be done by creating a <code>filter</code> that adds a header (called <code>JBoss-Node-Name</code> in this example) with a value of the <code>jboss.node.name</code> expression.
This value is equal to the Kubernetes pod ID.</p>
</div>
<div class="listingblock">
<div class="title">undertow-filter.cli</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cli">/subsystem=undertow/configuration=filter/response-header=node-name-header:add(header-name=&quot;JBoss-Node-Name&quot;,header-value=${jboss.node.name})
/subsystem=undertow/server=default-server/host=default-host/filter-ref=node-name-header:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secondly, after deploying any distributable application, query any URL that creates an HTTP session.</p>
</div>
<div class="listingblock">
<div class="title">undertow-filter.cli</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cli">$ curl http://example.com:8080/clusterbench/session --verbose --insecure --cookie-jar cookies.txt --cookie cookies.txt
*   Trying 127.0.0.1:8080...
* Connected to localhost (127.0.0.1) port 8080 (#0)
&gt; GET /clusterbench/session HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/8.1.2
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Connection: keep-alive
&lt; JBoss-Node-Name: de551585-8c99-4791-bcdb-45fdac253d87 <i class="conum" data-value="1"></i><b>(1)</b>
&lt; Set-Cookie: INGRESSCOOKIE=de551585-8c99-4791-bcdb-45fdac253d87; path=/ <i class="conum" data-value="2"></i><b>(2)</b>
&lt; Set-Cookie: JSESSIONID=EgxQStQ8zJ60lmDDO0VeY2H2OiLH3fdHRn2rqh5g; path=/clusterbench
&lt; X-JBoss-Node-Name: ribera
&lt; Content-Type: text/plain;charset=ISO-8859-1
&lt; Content-Length: 1
&lt; Date: Tue, 21 Nov 2023 14:58:48 GMT
&lt;
* Connection #0 to host localhost left intact
5</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the identity of the pod that actually processed the request.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the affinity supplied by the application server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the affinity is working correctly, these two value will match when the cluster topology is stable.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="HA_Singleton_Features"><a class="anchor" href="#HA_Singleton_Features"></a>7. HA Singleton Features</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In general, an HA or clustered singleton is a service that exists on
multiple nodes in a cluster, but is active on just a single node at any
given time. If the node providing the service fails or is shut down, a
new singleton provider is chosen and started. Thus, other than a brief
interval when one provider has stopped and another has yet to start, the
service is always running on one node.</p>
</div>
<div class="sect2">
<h3 id="Singleton_subsystem"><a class="anchor" href="#Singleton_subsystem"></a>7.1. Singleton subsystem</h3>
<div class="paragraph">
<p>WildFly 10 introduced a "singleton" subsystem, which defines a set of
policies that define how an HA singleton should behave. A singleton
policy can be used to instrument singleton deployments or to create
singleton MSC services.</p>
</div>
<div class="sect3">
<h4 id="singleton-configuration"><a class="anchor" href="#singleton-configuration"></a>7.1.1. Configuration</h4>
<div class="paragraph">
<p>The
<a href="https://github.com/wildfly/wildfly/blob/10.0.0.Final/clustering/singleton/extension/src/main/resources/schema/wildfly-singleton_1_0.xsd">default
subsystem configuration</a> from WildFly&#8217;s ha and full-ha profile looks
like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:singleton:1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;singleton-policies</span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;singleton-policy</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-container</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;simple-election-policy</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/singleton-policy&gt;</span>
    <span class="tag">&lt;/singleton-policies&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A singleton policy defines:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A unique name</p>
</li>
<li>
<p>A cache container and cache with which to register singleton provider candidates</p>
</li>
<li>
<p>An election policy</p>
</li>
<li>
<p>A quorum (optional)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>One can add a new singleton policy via the following management
operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=singleton/singleton-policy=foo:add(cache-container=server)</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="cache-configuration"><a class="anchor" href="#cache-configuration"></a>Cache configuration</h5>
<div class="paragraph">
<p>The cache-container and cache attributes of a singleton policy must
reference a valid cache from the Infinispan subsystem. If no specific
cache is defined, the default cache of the cache container is assumed.
This cache is used as a registry of which nodes can provide a given
service and will typically use a replicated-cache configuration.</p>
</div>
</div>
<div class="sect4">
<h5 id="election-policies"><a class="anchor" href="#election-policies"></a>Election policies</h5>
<div class="paragraph">
<p>WildFly includes two singleton election policy implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>simple</strong><br>
Elects the provider (a.k.a. primary provider) of a singleton service based on a
specified position in a circular linked list of eligible nodes sorted by
descending age. Position=0, the default value, refers to the oldest
node, 1 is second oldest, etc. ; while position=-1 refers to the
youngest node, -2 to the second youngest, etc.<br>
e.g.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=singleton/singleton-policy=foo/election-policy=simple:add(position=-1)</code></pre>
</div>
</div>
</li>
<li>
<p><strong>random</strong><br>
Elects a random member to be the provider of a singleton service<br>
e.g.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=singleton/singleton-policy=foo/election-policy=random:add()</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="preferences"><a class="anchor" href="#preferences"></a>Preferences</h6>
<div class="paragraph">
<p>Additionally, any singleton election policy may indicate a preference
for one or more members of a cluster. Preferences may be defined either
via node name or via outbound socket binding name. Node preferences
always take precedent over the results of an election policy.<br>
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=singleton/singleton-policy=foo/election-policy=simple:list-add(name=name-preferences, value=nodeA)
/subsystem=singleton/singleton-policy=bar/election-policy=random:list-add(name=socket-binding-preferences, value=nodeA)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="quorum"><a class="anchor" href="#quorum"></a>Quorum</h5>
<div class="paragraph">
<p>Network partitions are particularly problematic for singleton services,
since they can trigger multiple singleton providers for the same service
to run at the same time. To defend against this scenario, a singleton
policy may define a quorum that requires a minimum number of nodes to be
present before a singleton provider election can take place. A typical
deployment scenario uses a quorum of N/2 + 1, where N is the anticipated
cluster size. This value can be updated at runtime, and will immediately
affect any active singleton services.<br>
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=singleton/singleton-policy=foo:write-attribute(name=quorum, value=3)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="non-ha-environments"><a class="anchor" href="#non-ha-environments"></a>7.1.2. Non-HA environments</h4>
<div class="paragraph">
<p>The singleton subsystem can be used in a non-HA profile, so long as the
cache that it references uses a local-cache configuration. In this
manner, an application leveraging singleton functionality (via the
singleton API or using a singleton deployment descriptor) will continue
function as if the server was a sole member of a cluster. For obvious
reasons, the use of a quorum does not make sense in such a
configuration.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Singleton_deployments"><a class="anchor" href="#Singleton_deployments"></a>7.2. Singleton deployments</h3>
<div class="paragraph">
<p>WildFly 10 resurrected the ability to start a given deployment on a
single node in the cluster at any given time. If that node shuts down,
or fails, the application will automatically start on another node on
which the given deployment exists. Long time users of JBoss AS will
recognize this functionality as being akin to the
<a href="https://docs.jboss.org/jbossclustering/cluster_guide/5.1/html/deployment.chapt.html#d0e1220">HASingletonDeployer</a>,
a.k.a. "
<a href="https://docs.jboss.org/jbossclustering/cluster_guide/5.1/html/deployment.chapt.html#d0e1220">deploy-hasingleton</a>",
feature of AS6 and earlier.</p>
</div>
<div class="sect3">
<h4 id="usage-singleton-deployments"><a class="anchor" href="#usage-singleton-deployments"></a>7.2.1. Usage</h4>
<div class="paragraph">
<p>A deployment indicates that it should be deployed as a singleton via a
deployment descriptor. This can either be a standalone
<code>/META-INF/singleton-deployment.xml</code> file or embedded within an existing
jboss-all.xml descriptor. This descriptor may be applied to any
deployment type, e.g. JAR, WAR, EAR, etc., with the exception of a
subdeployment within an EAR.<br>
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;singleton-deployment</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:singleton-deployment:1.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The singleton deployment descriptor defines which
<a href="#Singleton_subsystem">singleton policy</a> should be used to deploy the
application. If undefined, the default singleton policy is used, as
defined by the singleton subsystem.</p>
</div>
<div class="paragraph">
<p>Using a standalone descriptor is often preferable, since it may be
overlaid onto an existing deployment archive.<br>
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>deployment-overlay add --name=singleton-policy-foo --content=/META-INF/singleton-deployment.xml=/path/to/singleton-deployment.xml --deployments=my-app.jar --redeploy-affected</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="singleton-deployment-metrics"><a class="anchor" href="#singleton-deployment-metrics"></a>7.2.2. Singleton Deployment metrics</h4>
<div class="paragraph">
<p>The singleton subsystem registers a set of runtime metrics for each singleton deployment installed on the server.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">is-primary</dt>
<dd>
<p>Indicates whether the node on which the operation was performed is the primary provider of the given singleton deployment</p>
</dd>
<dt class="hdlist1">primary-provider</dt>
<dd>
<p>Identifies the node currently operating as the primary provider for the given singleton deployment</p>
</dd>
<dt class="hdlist1">providers</dt>
<dd>
<p>Identifies the set of nodes on which the given singleton deployment is installed.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=singleton/singleton-policy=foo/deployment=bar.ear:read-attribute(name=primary-provider)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Singleton_MSC_services"><a class="anchor" href="#Singleton_MSC_services"></a>7.3. Singleton MSC services</h3>
<div class="paragraph">
<p>The singleton service facility exposes a mechanism for installing an MSC service such that the service only starts on a single member of a cluster at a time.
If the member providing the singleton service is shutdown or crashes, the facility automatically elects a new primary provider and starts the service on that node.
In general, a singleton election happens in response to any change of membership, where the membership is defined as the set of cluster nodes on which the given service was installed.</p>
</div>
<div class="sect3">
<h4 id="installing-an-msc-service-using-an-existing-singleton-policy"><a class="anchor" href="#installing-an-msc-service-using-an-existing-singleton-policy"></a>7.3.1. Installing an MSC service using an existing singleton policy</h4>
<div class="paragraph">
<p>While singleton MSC services have been around since AS7, WildFly adds the ability to leverage the singleton subsystem to create singleton MSC services from existing singleton policies.</p>
</div>
<div class="paragraph">
<p>The singleton subsystem exposes capabilities for each singleton policy it defines.</p>
</div>
<div class="paragraph">
<p>These policies, encapsulated by the <code>org.wildfly.clustering.singleton.service.SingletonPolicy</code> interface, can be referenced via the following capability name:
"org.wildfly.clustering.singleton.policy" + <em>policy-name</em></p>
</div>
<div class="paragraph">
<p>You can reference the default singleton policy of the server via the name:
"org.wildfly.clustering.singleton.default-policy"
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyServiceActivator</span> <span class="directive">implements</span> ServiceActivator {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> activate(ServiceActivatorContext context) {
        ServiceName name = ServiceName.parse(<span class="string"><span class="delimiter">&quot;</span><span class="content">my.service.name</span><span class="delimiter">&quot;</span></span>);
        <span class="comment">// Use default singleton policy</span>
        Supplier&lt;SingletonPolicy&gt; policy = <span class="keyword">new</span> ActiveServiceSupplier&lt;&gt;(context.getServiceTarget(), ServiceName.parse(SingletonDefaultRequirement.SINGLETON_POLICY.getName()));
        ServiceBuilder&lt;?&gt; builder = policy.get().createSingletonServiceConfigurator(name).build(context.getServiceTarget());
        Service service = <span class="keyword">new</span> MyService();
        builder.setInstance(service).install();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="singleton-msc-service-metrics"><a class="anchor" href="#singleton-msc-service-metrics"></a>7.3.2. Singleton MSC Service metrics</h4>
<div class="paragraph">
<p>The singleton subsystem registers a set of runtime metrics for each singleton MSC service installed via a given singleton policy.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">is-primary</dt>
<dd>
<p>Indicates whether the node on which the operation was performed is the primary provider of the given singleton service</p>
</dd>
<dt class="hdlist1">primary-provider</dt>
<dd>
<p>Identifies the node currently operating as the primary provider for the given singleton service</p>
</dd>
<dt class="hdlist1">providers</dt>
<dd>
<p>Identifies the set of nodes on which the given singleton service is installed.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/subsystem=singleton/singleton-policy=foo/service=my.service.name:read-attribute(name=primary-provider)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="installing-an-msc-service-using-dynamic-singleton-policy"><a class="anchor" href="#installing-an-msc-service-using-dynamic-singleton-policy"></a>7.3.3. Installing an MSC service using dynamic singleton policy</h4>
<div class="paragraph">
<p>Alternatively, you can configure a singleton policy dynamically, which is particularly useful if you want to use a custom singleton election policy.
<code>org.wildfly.clustering.singleton.service.SingletonPolicy</code> is a generalization of the <code>org.wildfly.clustering.singleton.service.SingletonServiceConfiguratorFactory</code> interface,
which includes support for specifying an election policy, an election listener, and, optionally, a quorum.</p>
</div>
<div class="paragraph">
<p>The SingletonElectionPolicy is responsible for electing a member to operate as the primary singleton service provider following any change in the set of singleton service providers.
Following the election of a new primary singleton service provider, any registered SingletonElectionListener is triggered on every member of the cluster.</p>
</div>
<div class="paragraph">
<p>The 'SingletonServiceConfiguratorFactory' capability may be referenced using the following capability name:
"org.wildfly.clustering.cache.singleton-service-configurator-factory" + <em>container-name</em> + "." + <em>cache-name</em></p>
</div>
<div class="paragraph">
<p>You can reference a 'SingletonServiceConfiguratorFactory' using the default cache of a given cache container via the name:
"org.wildfly.clustering.cache.default-singleton-service-configurator-factory" + <em>container-name</em></p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MySingletonElectionPolicy</span> <span class="directive">implements</span> SingletonElectionPolicy {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> Node elect(<span class="predefined-type">List</span>&lt;Node&gt; candidates) {
        <span class="comment">// ...</span>
        <span class="keyword">return</span> ...;
    }
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">MySingletonElectionListener</span> <span class="directive">implements</span> SingletonElectionListener {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> elected(<span class="predefined-type">List</span>&lt;Node&gt; candidates, Node primary) {
        <span class="comment">// ...</span>
    }
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">MyServiceActivator</span> <span class="directive">implements</span> ServiceActivator {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> activate(ServiceActivatorContext context) {
        <span class="predefined-type">String</span> containerName = <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>;
        SingletonElectionPolicy policy = <span class="keyword">new</span> MySingletonElectionPolicy();
        SingletonElectionListener listener = <span class="keyword">new</span> MySingletonElectionListener();
        <span class="type">int</span> quorum = <span class="integer">3</span>;
        ServiceName name = ServiceName.parse(<span class="string"><span class="delimiter">&quot;</span><span class="content">my.service.name</span><span class="delimiter">&quot;</span></span>);
        <span class="comment">// Use a SingletonServiceConfiguratorFactory backed by default cache of &quot;foo&quot; container</span>
        Supplier&lt;SingletonServiceConfiguratorFactory&gt; factory = <span class="keyword">new</span> ActiveServiceSupplier&lt;&gt;(context.getServiceTarget(), ServiceName.parse(SingletonDefaultCacheRequirement.SINGLETON_SERVICE_CONFIGURATOR_FACTORY.resolve(containerName).getName()));
        ServiceBuilder&lt;?&gt; builder = factory.get().createSingletonServiceConfigurator(name)
                .electionListener(listener)
                .electionPolicy(policy)
                .requireQuorum(quorum)
                .build(context.getServiceTarget());
        Service service = <span class="keyword">new</span> MyService();
        builder.setInstance(service).install();
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Clustering_API"><a class="anchor" href="#Clustering_API"></a>8. Clustering API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly exposes a public API to deployments for performing common clustering operations, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#group">Cluster membership introspection</a></p>
</li>
<li>
<p><a href="#command-dispatcher">Cluster command execution</a></p>
</li>
<li>
<p><a href="#service-provider-registry">A registry of service providers</a></p>
</li>
<li>
<p><a href="#registry">A member identification registry</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This zero-dependency API allows an application to perform basic clustering tasks, while remaining decoupled from the libraries that implement WildFly&#8217;s clustering logic.</p>
</div>
<div class="sect2">
<h3 id="group"><a class="anchor" href="#group"></a>8.1. Group membership</h3>
<div class="paragraph">
<p>The Group abstraction represents a logical cluster of nodes.
The Group service provides the following capabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>View the current membership of a group.</p>
</li>
<li>
<p>Identifies a designated coordinator for a given group membership. This designated coordinator will be the same on every node for a given membership. Traditionally, the oldest member of the cluster is chosen as the coordinator.</p>
</li>
<li>
<p>Registration facility for notifications of changes to group membership.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WildFly creates a Group instance for every defined channel defined in the JGroups subsystem, as well as a local implementation.
The local Group implementation is effectively a singleton membership containing only the current node.
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/group/ee</span><span class="delimiter">&quot;</span></span>) <span class="comment">// A Group representing the cluster of the &quot;ee&quot; channel</span>
<span class="directive">private</span> <span class="predefined-type">Group</span> group;

<span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/group/local</span><span class="delimiter">&quot;</span></span>) <span class="comment">// A non-clustered Group</span>
<span class="directive">private</span> <span class="predefined-type">Group</span> localGroup;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To ensure that your application operates consistently regardless of server configuration, you are strongly recommended to reference a given Group using an alias.
Most users should use the "default" alias, which references either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Group backed by the default channel of the server, if the JGroups subsystem is present</p>
</li>
<li>
<p>A non-clustered Group, if the JGroups subsystem is not present</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/group/default</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">Group</span> group;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, WildFly creates a Group alias for every Infinispan cache-container, which references:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Group backed by the transport channel of the cache container</p>
</li>
<li>
<p>A non-clustered Group, if the cache container has no transport</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is useful when using a Group within the context of an Infinispan cache.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/group/server</span><span class="delimiter">&quot;</span></span>) <span class="comment">// Backed by the transport of the &quot;server&quot; cache-container</span>
<span class="directive">private</span> <span class="predefined-type">Group</span> group;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="node"><a class="anchor" href="#node"></a>8.1.1. Node</h4>
<div class="paragraph">
<p>A Node encapsulates a member of a group (i.e. a JGroups address).
A Node has the following distinct characteristics, which will be unique for each member of the group:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">getName</dt>
<dd>
<p>The distinct logical name of this group member.
This value inherently defaults to the hostname of the machine, and can be overridden via the "jboss.node.name" system property.
You must override this value if you run multiple servers on the same host.</p>
</dd>
<dt class="hdlist1">getSocketAddress()</dt>
<dd>
<p>The distinct bind address/port used by this group member.
This will be null if the group is non-clustered.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="membership"><a class="anchor" href="#membership"></a>8.1.2. Membership</h4>
<div class="paragraph">
<p>A Membership is an immutable encapsulation of a group membership (i.e. a JGroups view).
Membership exposes the following properties:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">getMembers()</dt>
<dd>
<p>Returns the list of members comprising this group membership. The order of this list will be consistent on all nodes in the cluster.</p>
</dd>
<dt class="hdlist1">isCoordinator()</dt>
<dd>
<p>Indicates whether the current member is the coordinator of the group.</p>
</dd>
<dt class="hdlist1">getCoordinator()</dt>
<dd>
<p>Returns the member designated as coordinator of this group. This methods will return a consistent value for all nodes in the cluster.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="usage"><a class="anchor" href="#usage"></a>8.1.3. Usage</h4>
<div class="paragraph">
<p>The Group abstract is effectively a volatile reference to the current membership, and provides a facility for notification of membership changes.
It exposes the following properties and operations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">getName()</dt>
<dd>
<p>The logical name of this group.</p>
</dd>
<dt class="hdlist1">getLocalMember()</dt>
<dd>
<p>The Node instance corresponding to the local member.</p>
</dd>
<dt class="hdlist1">getMembership()</dt>
<dd>
<p>Returns the current membership of this group.</p>
</dd>
<dt class="hdlist1">register(GroupListener)</dt>
<dd>
<p>Registers the specific listener to be notified of changes to group membership.</p>
</dd>
<dt class="hdlist1">isSingleton()</dt>
<dd>
<p>Indicates whether the groups membership is non-clustered, i.e. will only ever contain a single member.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="example"><a class="anchor" href="#example"></a>8.1.4. Example</h4>
<div class="paragraph">
<p>A distributed "Hello world" example that prints joiners and leavers of a group membership:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyGroupListener</span> <span class="directive">implements</span> GroupListener {
    <span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/group/default</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">Group</span> group;
    <span class="directive">private</span> Registration&lt;GroupListener&gt; listenerRegistration;

    <span class="annotation">@PostConstruct</span>
    <span class="directive">public</span> <span class="type">void</span> init() {
        <span class="local-variable">this</span>.listenerRegistration = <span class="local-variable">this</span>.group.register(<span class="local-variable">this</span>);
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Initial membership: </span><span class="delimiter">&quot;</span></span> + <span class="local-variable">this</span>.group.getMembership().getMembers());
    }

    <span class="annotation">@PreDestroy</span>
    <span class="directive">public</span> <span class="type">void</span> destroy() {
        <span class="local-variable">this</span>.listenerRegistration.close(); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> membershipChanged(Membership previous, Membership current, <span class="type">boolean</span> merged) {
        <span class="predefined-type">List</span>&lt;Node&gt; previousMembers = previous.getMembers();
        <span class="predefined-type">List</span>&lt;Node&gt; currentMembers = current.getMembers();
        <span class="predefined-type">List</span>&lt;Node&gt; joiners = currentMembers.stream().filter(member -&gt; !previousMembers.contains(member)).collect(Collectors.toList());
        <span class="keyword">if</span> (!joiners.isEmpty()) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Welcome: </span><span class="delimiter">&quot;</span></span> + joiners);
        }
        <span class="predefined-type">List</span>&lt;Node&gt; leavers = previousMembers.stream().filter(member -&gt; !currentMembers.contains(member)).collect(Collectors.toList());
        <span class="keyword">if</span> (!leavers.isEmpty()) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Goodbye: </span><span class="delimiter">&quot;</span></span> + leavers);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Injects the default Group of the server</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Make sure to close your listener registration!</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="command-dispatcher"><a class="anchor" href="#command-dispatcher"></a>8.2. Command Dispatcher</h3>
<div class="paragraph">
<p>A command dispatcher is a mechanism for dispatching commands to be executed on members of a group.</p>
</div>
<div class="sect3">
<h4 id="commanddispatcherfactory"><a class="anchor" href="#commanddispatcherfactory"></a>8.2.1. CommandDispatcherFactory</h4>
<div class="paragraph">
<p>A command dispatcher is created from a CommandDispatcherFactory, an instance of which is created for every defined channel defined in the JGroups subsystem, as well as a local implementation.
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/dispatcher/ee</span><span class="delimiter">&quot;</span></span>) <span class="comment">// A command dispatcher factory backed by the &quot;ee&quot; channel</span>
<span class="directive">private</span> CommandDispatcherFactory factory;

<span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/dispatcher/local</span><span class="delimiter">&quot;</span></span>) <span class="comment">// The non-clustered command dispatcher factory</span>
<span class="directive">private</span> CommandDispatcherFactory localFactory;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To ensure that your application functions consistently regardless of server configuration, we recommended that you reference the CommandDispatcherFactory using an alias.
Most users should use the "default" alias, which references either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A CommandDispatcherFactory backed by the default channel of the server, if the JGroups subsystem is present</p>
</li>
<li>
<p>A non-clustered CommandDispatcherFactory, if the JGroups subsystem is not present</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/dispatcher/default</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> CommandDispatcherFactory factory;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, WildFly creates a CommandDispatcherFactory alias for every Infinispan cache-container, which references:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A CommandDispatcherFactory backed by the transport channel of the cache container</p>
</li>
<li>
<p>A non-clustered CommandDispatcherFactory, if the cache container has no transport</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is useful in the case where a CommandDispatcher is used to communicate with members on which a given cache is deployed.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/dispatcher/server</span><span class="delimiter">&quot;</span></span>) <span class="comment">// Backed by the transport of the &quot;server&quot; cache-container</span>
<span class="directive">private</span> CommandDispatcherFactory factory;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="command"><a class="anchor" href="#command"></a>8.2.2. Command</h4>
<div class="paragraph">
<p>A Command encapsulates logic to be executed on a group member.
A Command can leverage 2 type of parameters during execution:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Sender supplied parameters</dt>
<dd>
<p>These are member variables of the Command implementation itself, and are provided during construction of the Command object.
As properties of a serializable object, these must also be serializable.</p>
</dd>
<dt class="hdlist1">Receiver supplied parameters, i.e. local context</dt>
<dd>
<p>These are encapsulated in a single object, supplied during construction of the CommandDispatcher.
The command dispatcher passes the local context as a parameter to the Command.execute(&#8230;&#8203;) method.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="commanddispatcher"><a class="anchor" href="#commanddispatcher"></a>8.2.3. CommandDispatcher</h4>
<div class="paragraph">
<p>The CommandDispatcherFactory creates a CommandDispatcher using a service identifier and a local context.
This service identifier is used to segregate commands from multiple command dispatchers.
A CommandDispatcher will only receive commands dispatched by a CommandDispatcher with the same service identifier.</p>
</div>
<div class="paragraph">
<p>Once created, a CommandDispatcher will locally execute any received commands until it is closed.
Once closed, a CommandDispatcher is no longer allowed to dispatch commands.</p>
</div>
<div class="paragraph">
<p>The functionality of a CommandDispatcher boils down to 2 operations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">executeOnMember(Command, Node)</dt>
<dd>
<p>Executes a given command on a specific group member.</p>
</dd>
<dt class="hdlist1">executeOnGroup(Command, Node&#8230;&#8203;)</dt>
<dd>
<p>Executes a given command on all members of the group, optionally excluding specific members</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Both methods return responses as a <a href="https://docs.oracle.com/javase/8/docs/api/">CompletionStage</a>, allowing for asynchronous processing of responses as they complete.</p>
</div>
</div>
<div class="sect3">
<h4 id="example-2"><a class="anchor" href="#example-2"></a>8.2.4. Example</h4>
<div class="paragraph">
<p>To demonstrate how to use a CommandDispatcher, let&#8217;s create a distributed "hello world" application.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s create a simple HelloWorld interface which enables the caller to send a specific message to the entire group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">HelloWorld</span> {
    <span class="type">void</span> send(<span class="predefined-type">String</span> message);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we need to define a local command execution context.
This should encapsulate any local information we need to make available to the execution of any command received by our CommandDispatcher.
For demonstration purposes, let&#8217;s make this a separate interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">LocalContext</span> {
    Node getLocalMember();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we create a "hello world" Command that contains a message from the sender, and responds with a message of its own.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">HelloWorldCommand</span> <span class="directive">implements</span> Command&lt;<span class="predefined-type">String</span>, LocalContext&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> message;

    <span class="directive">public</span> HelloWorldCommand(<span class="predefined-type">String</span> message) {
        <span class="local-variable">this</span>.message = message;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> execute(LocalContext context) {
        <span class="predefined-type">System</span>.out.println(<span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">Received message: %s</span><span class="delimiter">&quot;</span></span>, <span class="local-variable">this</span>.message);
        <span class="keyword">return</span> <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello from %s</span><span class="delimiter">&quot;</span></span>, context.getLocalMember().getName());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we create a @Singleton Jakarta Enterprise Beans that implements our HelloWorld interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Singleton</span>
<span class="annotation">@Startup</span>
<span class="annotation">@Local</span>(HelloWorld.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CommandDispatcherBean</span> <span class="directive">implements</span> HelloWorld, LocalContext {

    <span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/dispatcher/default</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> CommandDispatcherFactory factory;
    <span class="directive">private</span> CommandDispatcher&lt;LocalContext&gt; dispatcher;

    <span class="annotation">@PostConstruct</span>
    <span class="directive">public</span> <span class="type">void</span> init() {
        <span class="local-variable">this</span>.dispatcher = <span class="local-variable">this</span>.factory.createCommandDispatcher(<span class="local-variable">this</span>.getClass().getName(), <span class="local-variable">this</span>);
    }

    <span class="annotation">@PreDestroy</span>
    <span class="directive">public</span> <span class="type">void</span> destroy() {
        <span class="local-variable">this</span>.dispatcher.close(); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Node getLocalMember() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.factory.getGroup().getLocalMember();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> send(<span class="predefined-type">String</span> message) {
        <span class="predefined-type">Map</span>&lt;Node, CompletionStage&lt;<span class="predefined-type">String</span>&gt;&gt; responses = <span class="local-variable">this</span>.dispatcher.executeOnGroup(<span class="keyword">new</span> HelloWorldCommand(message), <span class="local-variable">this</span>.factory.getGroup().getLocalMember()); <i class="conum" data-value="3"></i><b>(3)</b>
        responses.values().forEach(stage -&gt; stage.exceptionally(<span class="exception">Exception</span>::getLocalizedMessage).thenAccept(<span class="predefined-type">System</span>.out::println));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uses the default CommandDispatcherFactory of the server</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Don&#8217;t forget to close your CommandDispatcher!</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We don&#8217;t want to send the message to ourselves, so we exclude the local member</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now you can use the HelloWorld.send(&#8230;&#8203;) operation to say hello to your cluster.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="service-provider-registry"><a class="anchor" href="#service-provider-registry"></a>8.3. Service Provider Registry</h3>
<div class="paragraph">
<p>A service provider registry is a specialized cache that tracks the group members that provide a given service.
The ServiceProviderRegistry might be used in concert with a CommandDispatcher to communicate between a subset of group members on which a given service is installed.
It includes a registration facility to receive notifications when the set of nodes providing a given service changes.
WildFly uses this internally in its Singleton service/deployment implementation to drive the primary election process.</p>
</div>
<div class="paragraph">
<p>WildFly exposes a ServiceProviderRegistry (from which a ServiceProviderRegistration is created) for each cache defined by the Infinispan subsystem.</p>
</div>
<div class="sect3">
<h4 id="example-3"><a class="anchor" href="#example-3"></a>8.3.1. Example</h4>
<div class="paragraph">
<p>The following is an example of using a ServiceProviderRegistry to publish the availability of a given singleton Jakarta Enterprise Beans.
The getProviders() method will return the set of nodes on which the ServiceProviderRegistrationBean is deployed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Singleton</span>
<span class="annotation">@Startup</span>
<span class="annotation">@Local</span>(ServiceProviderRegistry.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ServiceProviderRegistrationBean</span> <span class="directive">implements</span> ServiceProviderRegistration&lt;<span class="predefined-type">String</span>&gt;, ServiceProviderRegistration.Listener {
    <span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/providers/server/default</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> ServiceProviderRegistry registry;
    <span class="directive">private</span> ServiceProviderRegistration registration;

    <span class="annotation">@PostConstruct</span>
    <span class="directive">public</span> <span class="type">void</span> init() {
        <span class="local-variable">this</span>.registration = <span class="local-variable">this</span>.registry.register(<span class="local-variable">this</span>.getClass().getName(), <span class="local-variable">this</span>);
    }

    <span class="annotation">@PreDestroy</span>
    <span class="directive">public</span> <span class="type">void</span> destroy() {
        <span class="local-variable">this</span>.registration.close(); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> providersChanged(<span class="predefined-type">Set</span>&lt;Node&gt; providers) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">%s is now available on the following nodes: %s</span><span class="delimiter">&quot;</span></span>, <span class="local-variable">this</span>.getClass().getName(), providers);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getService() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.registration.getService();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;Node&gt; getProviders() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.registration.getProviders();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> close() {
        <span class="comment">// Do nothing - registration is close on bean destroy</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uses the default cache of the "server" cache container.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Remember to close the registration!</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="registry"><a class="anchor" href="#registry"></a>8.4. Registry</h3>
<div class="paragraph">
<p>A registry is a specialized cache for storing a unique key/value pair for each member of a group.
This is useful to bridge WildFly&#8217;s Group members to an internal identification system used by an application.
The Registry service includes a facility for notifying group members of new, updated, or obsolete registry entries.</p>
</div>
<div class="paragraph">
<p>WildFly exposes a RegistryFactory (from which a Registry is created) for each cache defined by the Infinispan subsystem.</p>
</div>
<div class="sect3">
<h4 id="example-4"><a class="anchor" href="#example-4"></a>8.4.1. Example</h4>
<div class="paragraph">
<p>The following Registry example assigns a UUID to each group member, allowing each member to query the identifier of any other member:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Singleton</span>
<span class="annotation">@Startup</span>
<span class="annotation">@Local</span>(<span class="predefined-type">Registry</span>.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">RegistryBean</span> <span class="directive">implements</span> <span class="predefined-type">Registry</span>&lt;<span class="predefined-type">UUID</span>, <span class="predefined-type">Void</span>&gt; {
    <span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/clustering/registry/server/default</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> RegistryFactory&lt;<span class="predefined-type">UUID</span>, <span class="predefined-type">Void</span>&gt; factory;
    <span class="directive">private</span> <span class="predefined-type">Registry</span>&lt;<span class="predefined-type">UUID</span>, <span class="predefined-type">Void</span>&gt; registry;

    <span class="annotation">@PostConstruct</span>
    <span class="directive">public</span> <span class="type">void</span> init() {
        <span class="local-variable">this</span>.registry = <span class="local-variable">this</span>.factory.createRegistry(<span class="keyword">new</span> <span class="predefined-type">AbstractMap</span>.SimpleImmutableEntry&lt;&gt;(<span class="predefined-type">UUID</span>.randomUUID(), <span class="predefined-constant">null</span>);
    }

    <span class="annotation">@PreDestroy</span>
    <span class="directive">public</span> <span class="type">void</span> destroy() {
        <span class="local-variable">this</span>.registry.close(); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Group</span> getGroup() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.registry.getGroup();
    }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">UUID</span>, <span class="predefined-type">Void</span>&gt; getEntries() {
            <span class="keyword">return</span> <span class="local-variable">this</span>.registry.getEntries();
        }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">UUID</span>, <span class="predefined-type">Void</span>&gt; getEntry(Node node) {
        <span class="keyword">return</span> <span class="local-variable">this</span>.registry.getEntry(node);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> close() {
        <span class="comment">// Do nothing - registry is closed on bean destroy</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uses the default cache of the "server" cache container.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Remember to close the registry!</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jgroups"><a class="anchor" href="#jgroups"></a>9. JGroups</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="JGroups_Subsystem"><a class="anchor" href="#JGroups_Subsystem"></a>9.1. JGroups Subsystem</h3>
<div class="sect3">
<h4 id="jgroups-purpose"><a class="anchor" href="#jgroups-purpose"></a>9.1.1. Purpose</h4>
<div class="paragraph">
<p>The JGroups subsystem provides group communication support for HA
services in the form of JGroups channels.</p>
</div>
<div class="paragraph">
<p>Named channel instances permit application peers in a cluster to
communicate as a group and in such a way that the communication
satisfies defined properties (e.g. reliable, ordered,
failure-sensitive). Communication properties are configurable for each
channel and are defined by the protocol stack used to create the
channel. Protocol stacks consist of a base transport layer (used to
transport messages around the cluster) together with a user-defined,
ordered stack of protocol layers, where each protocol layer supports a
given communication property.</p>
</div>
<div class="paragraph">
<p>The JGroups subsystem provides the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>allows definition of named protocol stacks</p>
</li>
<li>
<p>view run-time metrics associated with channels</p>
</li>
<li>
<p>specify a default stack for general use</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the following sections, we describe the JGroups subsystem.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
JGroups channels are created transparently as part of the clustering
functionality (e.g. on clustered application deployment, channels will
be created behind the scenes to support clustered features such as
session replication or transmission of SSO contexts around the cluster).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="jgroups-configuration-example"><a class="anchor" href="#jgroups-configuration-example"></a>9.1.2. Configuration example</h4>
<div class="paragraph">
<p>What follows is a sample JGroups subsystem configuration showing all of
the possible elements and attributes which may be configured. We shall
use this example to explain the meaning of the various elements and
attributes.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The schema for the subsystem, describing all valid elements and
attributes, can be found in the WildFly distribution, in the <code>docs/schema</code>
directory.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:jgroups:6.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;channels</span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ee</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;channel</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ee</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">stack</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ejb</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/channels&gt;</span>
    <span class="tag">&lt;stacks&gt;</span>
        <span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">udp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;transport</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UDP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-udp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PING</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_SOCK</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_ALL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VERIFY_SUSPECT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.NAKACK2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UNICAST3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.STABLE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.GMS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UFC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MFC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FRAG3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/stack&gt;</span>
        <span class="tag">&lt;stack</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tcp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;transport</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TCP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;socket-protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MPING</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-mping</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_SOCK</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FD_ALL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VERIFY_SUSPECT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.NAKACK2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UNICAST3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.STABLE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pbcast.GMS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MFC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;protocol</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FRAG3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/stack&gt;</span>
    <span class="tag">&lt;/stacks&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="subsystem"><a class="anchor" href="#subsystem"></a>&lt;subsystem&gt;</h5>
<div class="paragraph">
<p>This element is used to configure the subsystem within a WildFly system
profile.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>xmlns</code> This attribute specifies the XML namespace of the JGroups
subsystem and, in particular, its version.</p>
</li>
<li>
<p><code>default-stack</code> This attribute is used to specify a default stack for
the JGroups subsystem. This default stack will be used whenever a stack
is required but no stack is specified.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="stack"><a class="anchor" href="#stack"></a>&lt;stack&gt;</h5>
<div class="paragraph">
<p>This element is used to configure a JGroups protocol stack.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code> This attribute is used to specify the name of the stack.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="jgroups-transport"><a class="anchor" href="#jgroups-transport"></a>&lt;transport&gt;</h5>
<div class="paragraph">
<p>This element is used to configure the transport layer (required) of the
protocol stack.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code> This attribute specifies the transport type (e.g. UDP, TCP,
TCPGOSSIP)</p>
</li>
<li>
<p><code>socket-binding</code> This attribute references a defined socket binding in
the server profile. It is used when JGroups needs to create general
sockets internally.</p>
</li>
<li>
<p><code>diagnostics-socket-binding</code> This attribute references a defined
socket binding in the server profile. It is used when JGroups needs to
create sockets for use with the diagnostics program. For more about the
use of diagnostics, see the JGroups documentation for probe.sh.</p>
</li>
<li>
<p><code>default-executor</code> This attribute references a defined thread pool
executor in the threads subsystem. It governs the allocation and
execution of runnable tasks to handle incoming JGroups messages.</p>
</li>
<li>
<p><code>oob-executor</code> This attribute references a defined thread pool
executor in the threads subsystem. It governs the allocation and
execution of runnable tasks to handle incoming JGroups OOB
(out-of-bound) messages.</p>
</li>
<li>
<p><code>timer-executor</code> This attribute references a defined thread pool
executor in the threads subsystem. It governs the allocation and
execution of runnable timer-related tasks.</p>
</li>
<li>
<p><code>shared</code> This attribute indicates whether or not this transport is
shared amongst several JGroups stacks or not.</p>
</li>
<li>
<p><code>thread-factory</code> This attribute references a defined thread factory in
the threads subsystem. It governs the allocation of threads for running
tasks which are not handled by the executors above.</p>
</li>
<li>
<p><code>site</code> This attribute defines a site (data centre) id for this node.</p>
</li>
<li>
<p><code>rack</code> This attribute defines a rack (server rack) id for this node.</p>
</li>
<li>
<p><code>machine</code> This attribute defines a machine (host) is for this node.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
site, rack and machine ids are used by the Infinispan topology-aware
consistent hash function, which when using dist mode, prevents dist mode
replicas from being stored on the same host, rack or site
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>.</p>
</div>
<div class="sect5">
<h6 id="property"><a class="anchor" href="#property"></a>&lt;property&gt;</h6>
<div class="paragraph">
<p>This element is used to configure a transport property.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code> This attribute specifies the name of the protocol property. The
value is provided as text for the property element.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="protocol"><a class="anchor" href="#protocol"></a>&lt;protocol&gt;</h5>
<div class="paragraph">
<p>This element is used to configure a (non-transport) protocol layer in
the JGroups stack. Protocol layers are ordered within the stack.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code> This attribute specifies the name of the JGroups protocol
implementation (e.g. MPING, pbcast.GMS), with the package prefix
org.jgroups.protocols removed.</p>
</li>
<li>
<p><code>socket-binding</code> This attribute references a defined socket binding in
the server profile. It is used when JGroups needs to create general
sockets internally for this protocol instance.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="relay"><a class="anchor" href="#relay"></a>&lt;relay&gt;</h5>
<div class="paragraph">
<p>This element is used to configure the RELAY protocol for a JGroups
stack. RELAY is a protocol which provides cross-site replication between
defined sites (data centres). In the RELAY protocol, defined sites
specify the names of remote sites (backup sites) to which their data
should be backed up. Channels are defined between sites to permit the
RELAY protocol to transport the data from the current site to a backup
site.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>site</code> This attribute specifies the name of the current site. Site
names can be referenced elsewhere (e.g. in the JGroups remote-site
configuration elements, as well as backup configuration elements in the
Infinispan subsystem)</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="remote-site"><a class="anchor" href="#remote-site"></a>&lt;remote-site&gt;</h6>
<div class="paragraph">
<p>This element is used to configure a remote site for the RELAY protocol.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code> This attribute specifies the name of the remote site to which
this configuration applies.</p>
</li>
<li>
<p><code>stack</code> This attribute specifies a JGroups protocol stack to use for
communication between this site and the remote site.</p>
</li>
<li>
<p><code>cluster</code> This attribute specifies the name of the JGroups channel to
use for communication between this site and the remote site.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jgroups-use-cases"><a class="anchor" href="#jgroups-use-cases"></a>9.1.3. Use Cases</h4>
<div class="paragraph">
<p>In many cases, channels will be configured via XML as in the example
above, so that the channels will be available upon server startup.
However, channels may also be added, removed or have their
configurations changed in a running server by making use of the WildFly
management API command-line interface (CLI). In this section, we present
some key use cases for the JGroups management API.</p>
</div>
<div class="paragraph">
<p>The key use cases covered are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>adding a stack</p>
</li>
<li>
<p>adding a protocol to an existing stack</p>
</li>
<li>
<p>adding a property to a protocol</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The WildFly management API command-line interface (CLI) itself can be
used to provide extensive information on the attributes and commands
available in the JGroups subsystem interface used in these examples.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="add-a-stack"><a class="anchor" href="#add-a-stack"></a>Add a stack</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=jgroups/stack=mystack:add(transport={}, protocols={})</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-a-protocol-to-a-stack"><a class="anchor" href="#add-a-protocol-to-a-stack"></a>Add a protocol to a stack</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=jgroups/stack=mystack/transport=TRANSPORT:add(type=&lt;type&gt;, socket-binding=&lt;socketbinding&gt;)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=jgroups/stack=mystack:add-protocol(type=&lt;type&gt;, socket-binding=&lt;socketbinding&gt;)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-a-property-to-a-protocol"><a class="anchor" href="#add-a-property-to-a-protocol"></a>Add a property to a protocol</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=jgroups/stack=mystack/transport=TRANSPORT/property=&lt;property&gt;:add(value=&lt;value&gt;)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="member-discovery"><a class="anchor" href="#member-discovery"></a>9.2. Member Discovery</h3>
<div class="sect3">
<h4 id="discovery-for-kubernetes"><a class="anchor" href="#discovery-for-kubernetes"></a>9.2.1. Discovery for Kubernetes</h4>
<div class="paragraph">
<p><code>KUBE_PING</code> is a discovery protocol for JGroups cluster nodes managed by Kubernetes.
Since Kubernetes is in charge of launching nodes, it knows the addresses of all pods it started,
and is therefore an ideal place to ask for cluster discovery.
Discovery is therefore done by asking Kubernetes for a list of addresses of all cluster nodes.
Combined with <code>bind_port</code> / <code>port_range</code>, the protocol will then send a discovery request to all instances and wait for the responses.</p>
</div>
<div class="paragraph">
<p>To reconfigure an existing server profile with <code>KUBE_PING</code> use the following CLI batch replacing the namespace,
labels and stack name (<code>tcp</code>) with the target stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>batch
/subsystem=jgroups/stack=tcp/protocol=MPING:remove()
/subsystem=jgroups/stack=tcp/protocol=kubernetes.KUBE_PING:add(add-index=1, properties={namespace=&quot;production&quot;, labels=&quot;cluster=nyc&quot;})
run-batch</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To be able to query the Kubernetes server ensure view permissions are granted on the service account.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For advanced configuration options, please visit protocol&#8217;s documentation <a href="https://github.com/jgroups-extras/jgroups-kubernetes/blob/main/README.adoc">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="discovery-for-aws-ec2"><a class="anchor" href="#discovery-for-aws-ec2"></a>9.2.2. Discovery for AWS EC2</h4>
<div class="paragraph">
<p>The <code>org.jgroups.protocols.aws.S3_PING</code> is a discovery protocol using AWS S3 buckets as cluster information store.</p>
</div>
<div class="paragraph">
<p>To provision using Galleon, use the <code>jgroups-aws</code> layer.
Note that the layer does not update configuration, only provisions necessary modules.</p>
</div>
<div class="paragraph">
<p>The following minimal example updates the existing <code>tcp</code> stack to use this discovery protocol instead of <code>MPING</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>batch
/subsystem=jgroups/stack=tcp/protocol=MPING:remove()
/subsystem=jgroups/stack=tcp/protocol=org.jgroups.protocols.aws.S3_PING:add(add-index=1, module=&quot;org.jgroups.aws&quot;, properties={region_name=&quot;eu-central-1&quot;, bucket_name=&quot;jgroups-s3&quot;})
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>The S3 client used by the protocol uses the default credential store provider.
Refer to AWS documentation how to generate and supply appropriate credentials.
For instance, credentials can be provided by Java system properties (<code>aws.accessKeyId</code> and <code>aws.secretAccessKey</code>),
environmental properties (<code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>), etc.</p>
</div>
<div class="paragraph">
<p>For advanced configuration options, please visit protocol&#8217;s documentation <a href="https://github.com/jgroups-extras/jgroups-aws#readme">here</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="infinispan"><a class="anchor" href="#infinispan"></a>10. Infinispan</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Infinispan_Subsystem"><a class="anchor" href="#Infinispan_Subsystem"></a>10.1. Infinispan Subsystem</h3>
<div class="paragraph">
<p>The Infinispan subsystem configures a set of Infinispan cache containers and cache configurations for use by WildFly clustering services.</p>
</div>
<div class="sect3">
<h4 id="cache-container"><a class="anchor" href="#cache-container"></a>10.1.1. Cache container</h4>
<div class="paragraph">
<p>A cache container manages a set of cache configurations that share the same transport and marshalling configuration.
Cache containers returned by the Infinispan subsystem are auto-configured with the following customizations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A custom <a href="#transport">transport</a> capable of sharing a JGroups channel defined by the JGroups subsystem.</p>
</li>
<li>
<p>Uses WildFly&#8217;s mbean server, if the org.jboss.as.jmx extension is present.</p>
</li>
<li>
<p>Marshaller configured to resolve classes using JBoss Modules.</p>
</li>
<li>
<p>Marshaller configured with a set of marshalling optimizations for common JDK classes</p>
</li>
<li>
<p>Marshaller configured with additional Externalizers loadable from the configured module attribute.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>e.g. To create a new cache container that loads marshallers from the "org.bar" module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo:add(module=org.foo)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A cache container may designate a specific cache as its default cache, i.e. the cache returned via <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/manager/CacheContainer.html#getCache()">CacheContainer.getCache()</a>:</p>
</div>
<div class="paragraph">
<p>e.g. To set "bar" as the default cache of the "foo" container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo:write-attribute(name=default-cache, value=bar)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A cache container can be injected directly into Jakarta EE applications using the <code>@Resource</code> annotation, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/infinispan/container/foo</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> org.infinispan.manager.EmbeddedCacheManager container;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the server will not manage the lifecycle of any caches created from the injected cache manager.
The application is responsible for managing the lifecycle of manually created caches.</p>
</div>
<div class="sect4">
<h5 id="transport"><a class="anchor" href="#transport"></a>Transport</h5>
<div class="paragraph">
<p>Configures the mechanism used by clustered caches to communicate with each other.
It is only necessary to define a transport if the cache container contains clustered caches.</p>
</div>
<div class="paragraph">
<p>To create a JGroups transport using the default channel of the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/transport=jgroups:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a JGroups transport using a distinct "alpha" channel, that uses the "tcp" stack:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=jgroups/channel=alpha:add(stack=tcp)
/subsystem=infinispan/cache-container=foo/transport=jgroups:add(channel=alpha)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of transport attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
<div class="paragraph">
<p>To remove an existing JGroups transport, you can either use the standard remove resource operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/transport=jgroups:remove()</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203; or by adding the "none" transport (which will auto-remove any existing transport):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/transport=none:add(){allow-resource-service-restart=true}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cache-types"><a class="anchor" href="#cache-types"></a>Cache types</h5>
<div class="paragraph">
<p>Infinispan supports a number of cache types for use in both HA and non-HA server profiles.</p>
</div>
<div class="sect5">
<h6 id="local"><a class="anchor" href="#local"></a>Local</h6>
<div class="paragraph">
<p>A local cache stores a given cache entry only on the local node.
A local cache does not require a transport, as cache reads and writes are always local.</p>
</div>
<div class="paragraph">
<p>For more information about this cache type, refer to the <a href="https://infinispan.org/documentation/">the Infinispan documentation</a>.</p>
</div>
<div class="paragraph">
<p>To create a local cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of local-cache attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect5">
<h6 id="replicated"><a class="anchor" href="#replicated"></a>Replicated</h6>
<div class="paragraph">
<p>A replicated cache stores a given cache entry on every node in the cluster.
A replicated cache requires a transport, as cache writes are replicated to all nodes in the cluster on which the associated cache is running.</p>
</div>
<div class="paragraph">
<p>For more information about this cache type, refer to the <a href="https://infinispan.org/documentation/">the Infinispan documentation</a>.</p>
</div>
<div class="paragraph">
<p>To create a replicated cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/replicated-cache=bar:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of replicated-cache attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect5">
<h6 id="distributed"><a class="anchor" href="#distributed"></a>Distributed</h6>
<div class="paragraph">
<p>A distributed cache stores a given cache entry on a configurable number of nodes in the cluster, assigned via an algorithm based on consistent hashing.
A distributed cache requires a transport, as cache writes need to forward to each owner, and cache reads from a non-owner require a remote request.</p>
</div>
<div class="paragraph">
<p>For more information about this cache type, refer to the <a href="https://infinispan.org/documentation/">the Infinispan documentation</a>.</p>
</div>
<div class="paragraph">
<p>To create a distributed cache where a given entry is stored on 3 nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/distributed-cache=bar:add(owners=3)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of distributed-cache attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect5">
<h6 id="scattered"><a class="anchor" href="#scattered"></a>Scattered</h6>
<div class="paragraph">
<p>A scattered cache is a variation of a distributed cache that maintains 2 copies of a particular cache entry.
Consequently, it can only tolerate failure of a single node at a time.
Primary ownership of a cache entry is determined by the same mechanism used by a distributed cache,
while the backup copy is the node that last updated the entry.</p>
</div>
<div class="paragraph">
<p>This design means that a scattered cache only requires 1 remote invocation to write a given cache entry, regardless of which node initiated the cache operation.
By comparison, a distributed cache (with 2 owners) uses 1 remote invocation to write a cache entry if and only if the primary owner initiated the cache operation, and otherwise requires 2 remote invocations.</p>
</div>
<div class="paragraph">
<p>For more information about this cache type, refer to the <a href="https://infinispan.org/documentation/">the Infinispan documentation</a>.</p>
</div>
<div class="paragraph">
<p>To create a scattered cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/scattered-cache=bar:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of scattered-cache attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect5">
<h6 id="invalidation"><a class="anchor" href="#invalidation"></a>Invalidation</h6>
<div class="paragraph">
<p>An invalidation cache is a special type of clustered cache that does not share state, but instead ensures that remote state is invalidated any time a given entry is updated locally.
An invalidation cache requires a transport, as cache writes trigger invalidation on remote nodes on which the associated cache is running.</p>
</div>
<div class="paragraph">
<p>For more information about this cache type, refer to the <a href="https://infinispan.org/documentation/">the Infinispan documentation</a>.</p>
</div>
<div class="paragraph">
<p>To create an invalidation cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/invalidation-cache=bar:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of invalidation-cache attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cache-features"><a class="anchor" href="#cache-features"></a>Cache features</h5>
<div class="paragraph">
<p>The configuration of a cache is divided into several components, each defining a specific cache feature.
Because a given cache configuration requires each component relevant to its cache type, cache add operations and cache component add operations are typically batched.
Any undefined components are auto-created using their defaults.</p>
</div>
<div class="paragraph">
<p>e.g. The following cache add operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203; is actually equivalent to the following sequence of operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>batch
/subsystem=infinispan/cache-container=foo/local-cache=bar:add()
/subsystem=infinispan/cache-container=foo/local-cache=bar/component=expiration:add()
/subsystem=infinispan/cache-container=foo/local-cache=bar/component=locking:add()
/subsystem=infinispan/cache-container=foo/local-cache=bar/component=transaction:add()
/subsystem=infinispan/cache-container=foo/local-cache=bar/memory=object:add()
/subsystem=infinispan/cache-container=foo/local-cache=bar/store=none:add()
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, you can reset all the attributes of a component by simply removing the component.
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar:component=expiration:remove(){allow-resource-service-restart=true}</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203; is equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar:component=expiration:remove(){allow-resource-service-restart=true}
/subsystem=infinispan/cache-container=foo/local-cache=bar:component=expiration:add(){allow-resource-service-restart=true}</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="memory"><a class="anchor" href="#memory"></a>Memory</h6>
<div class="paragraph">
<p>An Infinispan cache can be configured to store cache entries as Java objects or as binary data (i.e. byte[]), either on or off the JVM heap.
The type of storage used has semantic implications for the user of the cache.
When using object storage, the cache has store-as-reference semantics, whereas when using binary storage the cache has call-by-value semantics.
Consider the following logic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; list = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
cache.startBatch();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>, list);
list.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);
cache.endBatch(<span class="predefined-constant">true</span>);

<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">System</span>.out.println(result.size());</code></pre>
</div>
</div>
<div class="paragraph">
<p>How many elements are in the "result" list? The answer depends on how the cache is configured.</p>
</div>
<div class="paragraph">
<p>When the cache is configured to use object memory, our result list has 1 element.
When the cache is configured to use binary (or off-heap) memory, our result list is empty.
When using binary memory, the cache value must be marshalled to a byte[] on write and unmarshalled on read, thus any mutations of the cache value in the interim are not reflected in the cache.</p>
</div>
<div class="sect6">
<h7 id="object-storage"><a class="anchor" href="#object-storage"></a>Object storage</h7>
<div class="paragraph">
<p>When using object storage, cache keys and values are stored as Java object references.
Object storage may be configured with a maximum size.
When the number of entries in the cache exceeds this threshold, the least recently used entries are evicted from memory.</p>
</div>
<div class="paragraph">
<p>e.g. To store a maximum of 100 objects in the Java heap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/memory=object:add(size=100)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of memory=object attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect6">
<h7 id="binary-storage-on-heap"><a class="anchor" href="#binary-storage-on-heap"></a>Binary storage (on-heap)</h7>
<div class="paragraph">
<p>When using binary storage, each cache entry is stored as a byte[] within the JVM heap.
Binary storage may also be configured with a maximum size.
This size can be specified either as a maximum number of entries (i.e. COUNT), or as a maximum number of bytes (i.e. MEMORY).
When the number of entries in the cache exceeds this threshold, the least recently used entries are evicted from memory.</p>
</div>
<div class="paragraph">
<p>e.g. To store a maximum of 1 MB of binary data in the Java heap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/memory=binary:add(size=1048576, eviction-type=MEMORY)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of memory=binary attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect6">
<h7 id="off-heap-binary-storage"><a class="anchor" href="#off-heap-binary-storage"></a>Off-heap binary storage</h7>
<div class="paragraph">
<p>When using off-heap storage, each cache entry is stored as a byte[] in native memory allocated via sun.misc.Unsafe.
Off-heap memory storage may also be configured with a maximum size, specified either as a maximum number of entries (i.e. COUNT), or as a maximum number of bytes (i.e. MEMORY).
When the number of entries in the cache exceeds this threshold, the least recently used entries are evicted from memory.</p>
</div>
<div class="paragraph">
<p>e.g. To store a maximum of 1 GB of binary data in native memory outside of the Java heap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/memory=off-heap:add(size=1073741824)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of memory=off-heap attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="transactions"><a class="anchor" href="#transactions"></a>Transactions</h6>
<div class="paragraph">
<p>An Infinispan cache can be configured as transactional or non-transactional.
This behavior is determined by the mode attribute, which supports the following values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">NONE</dt>
<dd>
<p>Non-transactional cache (the default behavior).</p>
</dd>
<dt class="hdlist1">BATCH</dt>
<dd>
<p>Transactional cache using a local Infinispan transaction manager.
Infinispan transactions are started/committed/rolled-back using <a href="http://docs.jboss.org/infinispan/9.2/apidocs/org/infinispan/commons/api/BatchingCache.html">Infinispan&#8217;s batching API</a>.</p>
</dd>
<dt class="hdlist1">NON_XA</dt>
<dd>
<p>Transactional cache configured to use the server&#8217;s transaction manager, registering as a Synchronization to the current transaction.
Cache commit/rollback happens after the associated transaction completes.</p>
</dd>
<dt class="hdlist1">NON_DURABLE_XA</dt>
<dd>
<p>Transactional cache configured to use the server&#8217;s transaction manager, enlisting as an XAResource to the current transaction, but without transaction recovery support.</p>
</dd>
<dt class="hdlist1">FULL_XA</dt>
<dd>
<p>Transactional cache configured to use the server&#8217;s transaction manager, with full transaction recovery support.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Within the context of a transaction, cache write operations must obtain a lock on the affected keys.
Locks may be acquired either pessimistically (the default), i.e. before invoking the operation, or optimistically, i.e. before transaction commit.</p>
</div>
<div class="paragraph">
<p>e.g. To configure a transactional cache using local Infinispan transactions with OPTIMISTIC locking:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/component=transaction(mode=BATCH, locking=OPTIMISTIC)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of transaction attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect5">
<h6 id="locking"><a class="anchor" href="#locking"></a>Locking</h6>
<div class="paragraph">
<p>Within the context of a transaction, entries read from the cache are isolated from other concurrent transactions according to the configured isolation level.
Infinispan supports the following transaction isolation levels:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">READ_COMMITTED</dt>
<dd>
<p>A cache read may return a different value than a previous read within the same transaction, even if a concurrent transaction updated the entry.
This is the default isolation level.</p>
</dd>
<dt class="hdlist1">REPEATABLE_READ</dt>
<dd>
<p>A cache read will return the same value as a previous read within the same transaction, even if a concurrent transaction updated the entry.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Cache reads are always lock-free unless invoked using Flag.FORCE_WRITE_LOCK.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>e.g. To configure a cache using REPEATABLE_READ isolation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/component=locking(isolation=REPEATABLE_READ)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of locking attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect5">
<h6 id="expiration"><a class="anchor" href="#expiration"></a>Expiration</h6>
<div class="paragraph">
<p>The expiration component configures expiration defaults for cache entries.
Cache entries may be configured to expire after some duration since creation (i.e. lifespan) or since last accessed (i.e. max-idle).</p>
</div>
<div class="paragraph">
<p>e.g. To configure expiration of entries older than 1 day, or that have not been accessed within the past hour:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/component=expiration(lifespan=86400000, max-idle=3600000)</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
max-idle based expiration is not generally safe for use with clustered caches, as the meta data of a cache entry is not replicated by cache read operations
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For a complete list of expiration attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect5">
<h6 id="persistence"><a class="anchor" href="#persistence"></a>Persistence</h6>
<div class="paragraph">
<p>An Infinispan cache can optionally load/store cache entries from an external storage.
All cache stores support the following attributes:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">fetch-state</dt>
<dd>
<p>Indicates whether to refresh persistent state from cluster members on cache start.
Does not apply to a local or invalidation cache, nor a shared store.
Default is true.</p>
</dd>
<dt class="hdlist1">passivation</dt>
<dd>
<p>Indicates whether cache entries should only be persisted upon eviction from memory.
Default is true.</p>
</dd>
<dt class="hdlist1">preload</dt>
<dd>
<p>Indicates whether cache entries should be loaded into memory on cache start.
Default is false.</p>
</dd>
<dt class="hdlist1">purge</dt>
<dd>
<p>Indicates whether the cache store should be purged on cache start.
Purge should never be enabled on a shared store.
Default is true.</p>
</dd>
<dt class="hdlist1">shared</dt>
<dd>
<p>Indicates that the same cache store endpoint (e.g. database, data grid, etc.) is used by all members of the cluster.
When using a shared cache store, cache entries are only persisted by the primary owner of a given cache entry.
Default is false.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To remove an existing cache store, you can either use the standard resource remove operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/store=file:remove()</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203; or by adding the "none" store (which auto-removes any existing store):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/store=none:add(){allow-resource-service-restart=true}</code></pre>
</div>
</div>
<div class="sect6">
<h7 id="file-store"><a class="anchor" href="#file-store"></a>File store</h7>
<div class="paragraph">
<p>A file store persists cache entries to the local filesystem.
By default, files are stored in a file named "<em>cache-name</em>.dat" within a subdirectory named "infinispan/<em>container-name</em>" relative to the server&#8217;s data directory.</p>
</div>
<div class="paragraph">
<p>e.g. To persist cache entries to $HOME/foo/bar.dat:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/store=file:add(path=foo, relative-to=user.home)</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="jdbc-store"><a class="anchor" href="#jdbc-store"></a>JDBC store</h7>
<div class="paragraph">
<p>A JDBC store persists cache entries to a database.</p>
</div>
<div class="paragraph">
<p>e.g. To persist cache entries to an H2 database via the ExampleDS data-source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/store=jdbc:add(data-source=ExampleDS, dialect=H2)</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="hotrod_store"><a class="anchor" href="#hotrod_store"></a>HotRod store</h7>
<div class="paragraph">
<p>The HotRod store uses one dedicated remote cache for each cache created by the server.
For Infinispan Server versions supporting protocol version 2.7 and above (Infinispan Server version 9.2)
a persistent remote cache will be automatically created based on default configuration.
The recommended configuration for the remote cache where session data will be offloaded is transactional distribution mode cache with pessimistic locking.
When using Infinispan Server version prior to 9.2, the caches need to be configured manually on the server where cache names correspond to the deployment file names (e.g. <code>test.war</code>).</p>
</div>
<div class="paragraph">
<p>Once a <a href="#remote_cache_container">Remote Cache Container</a> is configured a <code>hotrod</code> store can be configured replacing any existing store.
The following CLI script demonstrates a typical use case for offloading sessions using an <code>invalidation-cache</code> with a shared, persistent infinispan-server store referencing an existing <code>remote-cache-container</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>batch
/subsystem=infinispan/cache-container=web/invalidation-cache=foo:add()
/subsystem=infinispan/cache-container=web/invalidation-cache=foo/store=hotrod:add(remote-cache-container=web, cache-configuration=transactional, fetch-state=false, shared=true)
/subsystem=infinispan/cache-container=web/invalidation-cache=foo/component=transaction:add(mode=BATCH)
/subsystem=infinispan/cache-container=web/invalidation-cache=foo/component=locking:add(isolation=REPEATABLE_READ)
run-batch</code></pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="state-transfer"><a class="anchor" href="#state-transfer"></a>State transfer</h6>
<div class="paragraph">
<p>The state transfer component defines the behavior for the initial transfer of state from remote caches on cache start.
State transfer is only applicable to distributed and replicated caches.
When configured with a timeout, a cache is only available after its initial state transfer completes.
If state transfer does not complete within the configured timeout, the cache will fail to start.</p>
</div>
<div class="paragraph">
<p>e.g. To configure a state-transfer timeout of 1 minute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/component=state-transfer:add(timeout=60000)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, state transfer can be configured to be non-blocking, by configuring a timeout of 0.
While this prevents timeouts due to large state transfers, cache operations on the new node will require remote invocations to retrieve the requisite state until state transfer is complete.</p>
</div>
<div class="paragraph">
<p>e.g. To configure a non-blocking state transfer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/cache-container=foo/local-cache=bar/component=state-transfer:add(timeout=0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of state-transfer attributes, refer to the <a href="wildscribe" target="_blank" rel="noopener">WildFly management model documentation</a></p>
</div>
</div>
<div class="sect5">
<h6 id="injecting-a-cache-into-jakarta-ee-applications"><a class="anchor" href="#injecting-a-cache-into-jakarta-ee-applications"></a>Injecting a cache into Jakarta EE applications</h6>
<div class="paragraph">
<p>A cache can be injected directly into Jakarta EE applications using the <code>@Resource</code> annotation, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/infinispan/cache/foo/bar</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">private</span> org.infinispan.Cache&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">Object</span>&gt; cache;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>where <code>foo</code> is the name of the cache container and <code>bar</code> is the name of the cache to inject</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>or in order to inject the default cache of the cache container use the following resource lookup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/infinispan/cache/foo/default</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="remote_cache_container"><a class="anchor" href="#remote_cache_container"></a>10.1.2. Remote Cache Container</h4>
<div class="paragraph">
<p>While Infinispan project is used as a library internally by WildFly to provide data distribution, Infinispan project is also distributed in a standalone server mode.
The Infinispan Server cluster operates as a language-independent service accessed remotely over a number of protocols (HotRod, REST, etc).</p>
</div>
<div class="paragraph">
<p>HotRod is Infinispan&#8217;s custom optimized binary protocol which was designed to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>enable faster client/server interactions compared to other existing text-based protocols,</p>
</li>
<li>
<p>allow clients to make more intelligent decisions with regards to load-balancing, failover,</p>
</li>
<li>
<p>and provide advanced cache operations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To learn more about the HotRod protocol itself and how to setup and run Infinispan Server,
refer to <a href="http://infinispan.org/documentation/">Infinispan documentation</a> for the appropriate version.</p>
</div>
<div class="sect4">
<h5 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h5>
<div class="paragraph">
<p>To configure a <code>remote-cache-container</code> ensure you have a list of available Infinispan Server nodes.
The following example CLI script first adds socket bindings to two known Infinispan Server nodes,
followed by configuration of the cluster.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>batch
/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=infinispan-server-1:add(host=server1.example.com, port=11622)
/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=infinispan-server-2:add(host=server2.example.com, port=11722)
/subsystem=infinispan/remote-cache-container=foo:add(default-remote-cluster=bar)
/subsystem=infinispan/remote-cache-container=foo/remote-cluster=bar:add(socket-bindings=[infinispan-server-1, infinispan-server-2])
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>Upon reload, this will register necessary services for the client.
A HotRod client can be injected directly into Jakarta EE applications using the <code>@Resource</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/infinispan/remote-container/foo</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> org.infinispan.client.hotrod.RemoteCacheContainer client;</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="security"><a class="anchor" href="#security"></a>Security</h6>
<div class="paragraph">
<p>Securing the store is just a matter of configuring the <code>remote-cache-container</code> with an SSL context.
Please follow the Elytron security guide on how to configure new SSL context
and <a href="http://infinispan.org/documentation/">Infinispan documentation</a> on how to secure Infinispan Server instances.</p>
</div>
<div class="paragraph">
<p>Once the SSL Context is configured, use the following CLI script to configure <code>remote-cache-container</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/remote-cache-container=foo/component=security:write-attribute(name=ssl-context, value=hotrod-ssl-context)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="statistics"><a class="anchor" href="#statistics"></a>Statistics</h6>
<div class="paragraph">
<p>To enable the gathering of statistics for a given <code>remote-cache-container</code>, use the <code>statistics-enabled</code> attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/remote-cache-container=foo:write-attribute(name=statistics-enabled, value=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the exposed runtime metrics, users can tune the HotRod thread pool configuration by looking at active vs idle connections.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan:remote-cache-container=foo:read-resource(include-runtime=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Infinispan subsystem additionally exposes a runtime resource for each started remote cache instance.
The runtime remote cache resource exposes usage metrics (e.g. reads, writes, removes, etc) as well as metrics for tuning near-cache sizes (e.g. hits vs misses).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan:remote-cache-container=foo/remote-cache=bar:read-resource(include-runtime=true)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="switching-remote-clusters"><a class="anchor" href="#switching-remote-clusters"></a>Switching remote clusters</h6>
<div class="paragraph">
<p>If a remote-cache-container configures multiple remote-clusters (e.g. when the infinispan servers are configured with cross site replication),
the hotrod client can toggle the remote-cluster with which it interacts via a runtime management operation.</p>
</div>
<div class="paragraph">
<p>For example, when the client is configured with multiple remote clusters, typically representing multiple data centers (this presumes that the infinispan servers are configured with cross-site replication),
if connectivity to the default remote cluster fails, the client will automatically fail over to a backup remote cluster.
Once the underlying connectivity issue is resolved, a user can manually fail back to the local site via the <code>switch-cluster</code> operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/subsystem=infinispan/remote-cache-container=foo/remote-cluster=bar:switch-cluster()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This operation returns <code>true</code> if the switch was successful, or <code>false</code> otherwise.
See the server log for specifics in the event that the switch was unsuccessful.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced-topics"><a class="anchor" href="#advanced-topics"></a>11. Advanced Topics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section aims to describe cross-cutting topics, such as marshalling.</p>
</div>
<div class="sect2">
<h3 id="marshalling"><a class="anchor" href="#marshalling"></a>11.1. Marshalling</h3>
<div class="paragraph">
<p>In general, the most effective way to improve the scalability of a system with persistent or distributed state is to reduce the number of bytes needed to be sent over the network or persisted to storage.
Marshalling is the process by which Java objects in heap space are converted to a byte buffer for replication to other JVMs or for persistence to local or shared storage.</p>
</div>
<div class="paragraph">
<p>WildFly generally supports 2 marshalling mechanisms for use with its clustering modules: JBoss Marshalling and ProtoStream.</p>
</div>
<div class="sect3">
<h4 id="jboss_marshalling"><a class="anchor" href="#jboss_marshalling"></a>11.1.1. JBoss Marshalling</h4>
<div class="paragraph">
<p><a href="https://jbossmarshalling.jboss.org/">JBoss Marshalling</a> is a serialization library for objects implementing <code>java.io.Serializable</code>.</p>
</div>
<div class="paragraph">
<p>When configured to use JBoss Marshalling, an application can optimize the marshalling of a given object, either through custom JDK serialization logic, or by implementing a custom externalizer.
An externalizer is an implementation of the <code>org.wildfly.clustering.marshalling.Externalizer</code> interface, which dictates how a given class should be marshalled.
An externalizer reads/writes the state of an object directly from/to an input/output stream, but also:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allows an application to replicate/persist an object that does not implement <code>java.io.Serializable</code></p>
</li>
<li>
<p>Eliminates the need to serialize the class descriptor of an object along with its state</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyObjectExternalizer</span> <span class="directive">implements</span> org.wildfly.clustering.marshalling.Externalizer&lt;MyObject&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;MyObject&gt; getTargetClass() {
        <span class="keyword">return</span> MyObject.class;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, MyObject object) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="comment">// Write object state to stream</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> MyObject readObject(<span class="predefined-type">ObjectInput</span> input) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
        <span class="comment">// Construct and read object state from stream</span>
        <span class="keyword">return</span> ...;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Externalizers are dynamically loaded during deployment via the service loader mechanism.
Implementations should be enumerated within a file named:
<code>/META-INF/services/org.wildfly.clustering.marshalling.Externalizer</code></p>
</div>
</div>
<div class="sect3">
<h4 id="protostream"><a class="anchor" href="#protostream"></a>11.1.2. ProtoStream</h4>
<div class="paragraph">
<p><a href="https://github.com/infinispan/protostream">ProtoStream</a> is serialization library based on the <a href="https://developers.google.com/protocol-buffers">Protobuf</a> data format.
The nature of the Protobuf data format makes it very easy to evolve classes without breaking serialization compatibility.
When compared to JBoss Marshalling, ProtoStream is generally more efficient and generates smaller payloads, especially for objects containing fields that are either optional or have a default value.
Since marshallable classes are explicitly enumerated, ProtoStream is not vulnerable to the same arbitrary code execution exploits that affect JDK serialization.</p>
</div>
<div class="paragraph">
<p>When configured to use ProtoStream, a web application will need to register ProtoStream marshallers/schemas for <strong>every</strong> application-specific type.
WildFly initializes its ProtoStream marshaller using all instances of <code>org.infinispan.protostream.SerializationContextInitializer</code> that are visible to the deployment classpath.
Implementations should be enumerated within a file named:
<code>/META-INF/services/org.infinispan.protostream.SerializationContextInitializer</code></p>
</div>
<div class="paragraph">
<p>Simple objects can leverage ProtoStream annotations and <a href="https://infinispan.org/docs/stable/titles/encoding/encoding.html#adding-protostream-processor_marshalling">auto-generate marshallers and schemas at build time</a>.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@AutoProtoSchemaBuilder</span>(includeClasses = { Person.class })
<span class="directive">public</span> <span class="type">interface</span> <span class="class">PersonInitalizer</span> <span class="directive">extends</span> SerializationContextInitializer {
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span> {
    <span class="annotation">@ProtoField</span>(number = <span class="integer">1</span>)
    <span class="directive">final</span> <span class="predefined-type">String</span> name;
    <span class="annotation">@ProtoField</span>(number = <span class="integer">2</span>, type = <span class="predefined-type">Type</span>.UINT32, defaultValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">final</span> <span class="type">int</span> age;
    <span class="annotation">@ProtoField</span>(number = <span class="integer">3</span>)
    Person parent;
    <span class="annotation">@ProtoField</span>(number = <span class="integer">4</span>, collectionImplementation = <span class="predefined-type">LinkedList</span>.class)
    <span class="directive">final</span> <span class="predefined-type">List</span>&lt;Person&gt; children;

    <span class="annotation">@ProtoFactory</span>
    Person(<span class="predefined-type">String</span> name, <span class="type">int</span> age, Person parent, <span class="predefined-type">List</span>&lt;Person&gt; children) {
        <span class="local-variable">this</span>.name = name;
        <span class="local-variable">this</span>.age = age;
        <span class="local-variable">this</span>.parent = parent;
        <span class="local-variable">this</span>.children = children;
    }

    <span class="directive">public</span> Person(<span class="predefined-type">String</span> name, <span class="type">int</span> age) {
        <span class="local-variable">this</span>.name = name;
        <span class="local-variable">this</span>.age = age;
        <span class="local-variable">this</span>.children = <span class="keyword">new</span> <span class="predefined-type">LinkedList</span>&lt;&gt;();
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.name;
    }

    <span class="directive">public</span> <span class="type">int</span> getAge() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.age;
    }

    <span class="directive">public</span> Person getParent() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.parent;
    }

    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Person&gt; getChildren() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.children;
    }

    <span class="directive">public</span> <span class="type">void</span> setParent(Person parent) {
        <span class="local-variable">this</span>.parent = parent;
    }

    <span class="directive">public</span> <span class="type">void</span> addChild(Person child) {
        <span class="local-variable">this</span>.children.add(child);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sufficiently complex objects may require a custom <code>org.infinispan.protostream.SerializationContextInitializer</code> implementation to register custom marshaller implementations and schemas.
Refer to the <a href="https://infinispan.org/docs/stable/titles/encoding/encoding.html#marshalling_user_types">Infinispan documentation</a> for details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Clustering_and_Domain_Setup_Walkthrough"><a class="anchor" href="#Clustering_and_Domain_Setup_Walkthrough"></a>12. Clustering and Domain Setup Walkthrough</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this article, I&#8217;d like to show you how to setup WildFly in domain
mode and enable clustering so we could get HA and session replication
among the nodes. It&#8217;s a step to step guide so you can follow the
instructions in this article and build the sandbox by yourself.</p>
</div>
<div class="sect2">
<h3 id="preparation-scenario"><a class="anchor" href="#preparation-scenario"></a>12.1. Preparation &amp; Scenario</h3>
<div class="sect3">
<h4 id="preparation"><a class="anchor" href="#preparation"></a>12.1.1. Preparation</h4>
<div class="paragraph">
<p>We need to prepare two hosts (or virtual hosts) to do the experiment. We
will use these two hosts as following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install Fedora on them (Other linux version may also fine but I&#8217;ll
use Fedora in this article)</p>
</li>
<li>
<p>Make sure that they are in same local network</p>
</li>
<li>
<p>Make sure that they can access each other via different TCP/UDP
ports (better turn off firewall and disable SELinux during the experiment
or they will cause network problems).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="scenario"><a class="anchor" href="#scenario"></a>12.1.2. Scenario</h4>
<div class="paragraph">
<p>Here are some details on what we are going to do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Let&#8217;s call one host as 'primary', the other one as 'secondary'.</p>
</li>
<li>
<p>Both primary and secondary hosts will run WildFly, and the primary host
will run as a domain controller, the secondary host will under the domain management of primary host.</p>
</li>
<li>
<p>Apache httpd will be run on the primary host, and in httpd we will enable the
mod_cluster module. The WildFly on primary and secondary hosts will form a
cluster and discovered by httpd.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/clustering/Clustering.jpg" alt="clustering/Clustering.jpg"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>We will deploy a demo project into the domain, and verify that the project
is deployed into both primary and secondary Host Controllers by the domain controller.
Thus we could see that domain management provide us a single point to manage the
deployments across multiple hosts in a single domain.</p>
</li>
<li>
<p>We will access the cluster URL and verify that httpd has distributed
the request to one of the WildFly hosts. So we could see the cluster is
working properly.</p>
</li>
<li>
<p>We will try to make a request on cluster, and if the request is
forwarded to the Domain Controller, we then kill the WildFly process on the primary host. After
that we will go on requesting cluster and we should see the request is
forwarded to the secondary Host Controller, but the session is not lost. Our goal is to verify
the HA is working and sessions are replicated.</p>
</li>
<li>
<p>After previous step finished, we reconnect the Domain Controller by restarting
it. We should see the Domain Controller is registered back into cluster, also we
should see the secondary Host Controller sees the primary Host Controller as a domain controller again and connect to it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/clustering/test_scenario.jpg" alt="clustering/test_scenario.jpg"></span></p>
</div>
<div class="paragraph">
<p>Please don&#8217;t worry if you cannot digest so many details currently. Let&#8217;s
move on and you will get the points step by step.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="download-wildfly"><a class="anchor" href="#download-wildfly"></a>12.2. Download WildFly</h3>
<div class="paragraph">
<p>First we should download WildFly from the <a href="http://wildfly.org/downloads/">WildFly website</a>.</p>
</div>
<div class="paragraph">
<p>Then I unzipped the package to the primary host and try to make a test run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>unzip wildfly-31.0.0.Final.zip
cd wildfly-31.0.0.Final/bin
./domain.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything ok we should see WildFly successfully startup in domain
mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>wildfly-31.0.0.Final/bin$ ./domain.sh
=========================================================================

  JBoss Bootstrap Environment

  JBOSS_HOME: /Users/weli/Downloads/wildfly-31.0.0.Final

  JAVA: /Library/Java/Home/bin/java

  JAVA_OPTS: -Xms64m -Xmx512m -XX:MaxPermSize=256m -Djava.net.preferIPv4Stack=true -Dorg.jboss.resolver.warning=true -Dsun.rmi.dgc.client.gcInterval=3600000 -Dsun.rmi.dgc.server.gcInterval=3600000 -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=true

=========================================================================
...

[Server:server-two] 14:46:12,375 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015874: WildFly 31.0.0.Final &quot;Kenny&quot; started in 8860ms - Started 210 of 258 services (831 services are lazy, passive or on-demand)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now exit from the primary host and let&#8217;s repeat the same steps on the secondary host. Finally,
we get WildFly run on both primary and secondary hosts, then we could move on to
next step.</p>
</div>
</div>
<div class="sect2">
<h3 id="domain-configuration"><a class="anchor" href="#domain-configuration"></a>12.3. Domain Configuration</h3>
<div class="sect3">
<h4 id="interface-config-on-primary-hc"><a class="anchor" href="#interface-config-on-primary-hc"></a>12.3.1. Interface config on the Primary Host Controller</h4>
<div class="paragraph">
<p>In this section we&#8217;ll setup both the primary and secondary hosts for them to run in
domain mode. And we will configure the primary host to be the domain controller.</p>
</div>
<div class="paragraph">
<p>First open the host.xml in the primary host for editing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>vi domain/configuration/host.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default settings for interface in this file is like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;interfaces&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address.management:127.0.0.1}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address:127.0.0.1}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unsecured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
<span class="tag">&lt;/interfaces&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to change the address to the management interface so the secondary Host Controller could
connect to the primary Host Controller. The public interface allows the application to be
accessed by non-local HTTP, and the unsecured interface allows remote
RMI access. My primary host&#8217;s ip address is 10.211.55.7, so I change the
config to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;interfaces&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address.management:10.211.55.7}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address:10.211.55.7}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unsecured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
<span class="tag">&lt;/interfaces&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="interface-config-on-secondary-hc"><a class="anchor" href="#interface-config-on-secondary-hc"></a>12.3.2. Interface config on the Secondary Host Controller</h4>
<div class="paragraph">
<p>Now we will setup interfaces on the secondary host. Let&#8217;s edit host.xml. Similar to
the steps on the primary host, open host.xml first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>vi domain/configuration/host.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration we&#8217;ll use on the secondary host is a little bit different, because
we need to let the secondary Host Controller connect to the primary Host Controller. First we need to set the
hostname. We change the name property from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">primary</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secondary</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to modify domain-controller section so the secondary Host Controller can connect to
primary Host Controller management port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;domain-controller&gt;</span>
   <span class="tag">&lt;remote</span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">9999</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/domain-controller&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we know, 10.211.55.7 is the ip address of the primary host.
You may use discovery options to define multiple mechanisms to connect
to the remote domain controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;domain-controller&gt;</span>
 <span class="tag">&lt;remote</span> <span class="attribute-name">authentication-context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hcAuthContext</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
   <span class="tag">&lt;discovery-options&gt;</span>
     <span class="tag">&lt;static-discovery</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">primary-native</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote</span><span class="delimiter">&quot;</span></span>  <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">9999</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
     <span class="tag">&lt;static-discovery</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">primary-https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https-remoting</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">9993</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">authentication-context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hcAuthContext</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;static-discovery</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">primary-http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">protocol</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http-remoting</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.7</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">9990</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/discovery-options&gt;</span>
 <span class="tag">&lt;/remote&gt;</span>
<span class="tag">&lt;/domain-controller&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we also need to configure interfaces section and expose the
management ports to public address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;interfaces&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address.management:10.211.55.2}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address:10.211.55.2}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unsecured</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.211.55.2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/interface&gt;</span>
<span class="tag">&lt;/interfaces&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>10.211.55.2 is the ip address of the secondary host. Refer to the domain
controller configuration above for an explanation of the management,
public, and unsecured interfaces.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is easier to turn off all firewalls for testing, but in production,
you need to enable the firewall and allow access to the following ports:
9999.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="dry-run"><a class="anchor" href="#dry-run"></a>Dry Run</h5>
<div class="paragraph">
<p>Now everything is set for the two hosts to run in domain mode. Let&#8217;s
start them by running domain.sh on both hosts. If everything goes fine,
we could see from the log on the primary Host Controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[Host Controller] 21:30:52,042 INFO  [org.jboss.as.domain] (management-handler-threads - 1) JBAS010918: Registered remote secondary host &quot;secondary&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>That means all the configurations are correct and two hosts are run in
domain mode now as expected. Hurrah!</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deployment"><a class="anchor" href="#deployment"></a>12.4. Deployment</h3>
<div class="paragraph">
<p>Now we can deploy a demo project into the domain. I have created a
simple project located at:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>https://github.com/liweinan/cluster-demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use git command to fetch a copy of the demo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>git clone git@github.com:liweinan/cluster-demo.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this demo project we have a very simple web application. In web.xml
we&#8217;ve enabled session replication by adding following entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributable</span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And it contains a jsp page called put.jsp which will put current time to
a session entry called 'current.time':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">&lt;%
    session.setAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">current.time</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> java.util.Date());
%&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we could fetch this value from get.jsp:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>The time is &lt;%= session.getAttribute(&quot;current.time&quot;) %&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s an extremely simple project but it could help us to test the
cluster later: We will access put.jsp from cluster and see the request
are distributed to the primary host, then we disconnect the primary Host Controller and access get.jsp.
We should see the request is forwarded to secondary host but the 'current.time'
value is held by session replication. We&#8217;ll cover more details on this
one later.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to this demo project. Now we need to create a war from it.
In the project directory, run the following command to get the war:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>mvn package</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will generate cluster-demo.war. Then we need to deploy the war into
domain. First we should access the http management console on
primary host (Because primary host is acting as domain controller):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>http://10.211.55.7:9990</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will popup a windows ask you to input account name and password, we
can use the 'admin' account we&#8217;ve added just now. After logging in we
could see the 'Server Instances' window. By default there are three
servers listed, which are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>server-one</p>
</li>
<li>
<p>server-two</p>
</li>
<li>
<p>server-three</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We could see server-one and server-two are in running status and they
belong to main-server-group; server-three is in idle status, and it
belongs to other-server-group.</p>
</div>
<div class="paragraph">
<p>All these servers and server groups are set in domain.xml on the primary host.
What we are interested in is the 'other-server-group' in domain.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ha</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;jvm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;heap</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">64m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">512m</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/jvm&gt;</span>
   <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ha-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server-group&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could see this server-group is using 'ha' profile, which then uses
'ha-sockets' socket binding group. It enables all the modules we need to
establish cluster later (including infinispan, jgroup and mod_cluster
modules). So we will deploy our demo project into a server that belongs
to 'other-server-group', so 'server-three' is our choice.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In newer version of WildFly, the profile 'ha' changes to 'full-ha':
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">full-ha</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to domain controller&#8217;s management console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>http://10.211.55.7:9990</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now server-three is not running, so let&#8217;s click on 'server-three' and
then click the 'start' button at bottom right of the server list. Wait a
moment and server-three should start now.</p>
</div>
<div class="paragraph">
<p>Now we should also enable 'server-three' on the secondary Host Controller: From the top of menu
list on left side of the page, we could see now we are managing the primary Host Controller
currently. Click on the list, and click 'secondary', then choose
'server-three', and we are in secondary Host Controller management page now.</p>
</div>
<div class="paragraph">
<p>Then repeat the steps we&#8217;ve done on the primary host to start 'server-three' on
secondary host.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
server-three on primary and secondary host are two different hosts, their names
can be different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After server-three on both primary and secondary hosts are started, we will add our
cluster-demo.war for deployment. Click on the 'Manage Deployments' link
at the bottom of left menu list.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/clustering/JBoss_Management.png" alt="clustering/JBoss_Management.png"></span><br>
(We should ensure the server-three should be started on both primary and
secondary hosts)</p>
</div>
<div class="paragraph">
<p>After enter 'Manage Deployments' page, click 'Add Content' at top right
corner. Then we should choose our cluster-demo.war, and follow the
instruction to add it into our content repository.</p>
</div>
<div class="paragraph">
<p>Now we can see cluster-demo.war is added. Next we click 'Add to Groups'
button and add the war to 'other-server-group' and then click 'save'.</p>
</div>
<div class="paragraph">
<p>Wait a few seconds, management console will tell you that the project is
deployed into 'other-server-group'.：</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/clustering/JBoss_Management_2.png" alt="clustering/JBoss_Management_2.png"></span></p>
</div>
<div class="paragraph">
<p>Please note we have two hosts participate in this server group, so the
project should be deployed in both primary and secondary hosts now - that&#8217;s the
power of domain management.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s verify this, trying to access cluster-demo from both primary
and secondary hosts, and they should all work now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>http://10.211.55.7:8330/cluster-demo/</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/clustering/http---10.211.55.7-8330-cluster-demo-.png" alt="clustering/http---10.211.55.7-8330-cluster-demo-.png"></span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>http://10.211.55.2:8330/cluster-demo/</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/clustering/http---10.211.55.2-8330-cluster-demo-.png" alt="clustering/http---10.211.55.2-8330-cluster-demo-.png"></span></p>
</div>
<div class="paragraph">
<p>Now that we have finished the project deployment and see the usages of
domain controller, we will then head up for using these two hosts to
establish a cluster <span class="icon yellow"><i class="fa fa-smile-o"></i></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Why is the port number 8330 instead of 8080? Please check the settings
in host.xml on both primary and secondary hosts:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server-three</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;</span>
    <span class="tag">&lt;socket-bindings</span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">250</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The port-offset is set to 250, so 8080 + 250 = 8330</p>
</div>
<div class="paragraph">
<p>Now we quit the WildFly process on both primary and secondary hosts. We have some
work left on host.xml configurations. Open the host.xml of primary host, and
do some modifications the servers section from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server-three</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;</span>
    <span class="tag">&lt;socket-bindings</span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">250</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server-three</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;</span>
    <span class="tag">&lt;socket-bindings</span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">250</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve set auto-start to true so we don&#8217;t need to enable it in management
console each time WildFly restart. Now open secondary&#8217;s host.xml, and modify
the server-three section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server-three-secondary</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">other-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- server-three avoids port conflicts by incrementing the ports in
         the default socket-group declared in the server-group --&gt;</span>
    <span class="tag">&lt;socket-bindings</span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">250</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/server&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Besides setting auto-start to true, we&#8217;ve renamed the 'server-three' to
'server-three-secondary'. We need to do this because mod_cluster will fail
to register the hosts with same name in a single server group. It will
cause name conflict.</p>
</div>
<div class="paragraph">
<p>After finishing the above configuration, let&#8217;s restart two as7 hosts and
go on cluster configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="cluster-configuration"><a class="anchor" href="#cluster-configuration"></a>12.5. Cluster Configuration</h3>
<div class="paragraph">
<p>We will use mod_cluster + apache httpd on primary host as our cluster
controller here. Because WildFly has been configured to support
mod_cluster out of box so it&#8217;s the easiest way.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The WildFly domain controller and httpd are not necessary to be on
same host. But in this article I just install them all on primary host for
convenience.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First we need to ensure that httpd is installed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>sudo yum install httpd</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then we need to download newer version of mod_cluster from its
website:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>http://www.jboss.org/mod_cluster/downloads</code></pre>
</div>
</div>
<div class="paragraph">
<p>The version I downloaded is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>http://downloads.jboss.org/mod_cluster/1.1.3.Final/mod_cluster-1.1.3.Final-linux2-x86-so.tar.gz</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Jean-Frederic has suggested to use mod_cluster 1.2.x. Because 1.1.x it
is affected by CVE-2011-4608
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With mod_cluster-1.2.0 you need to add EnableMCPMReceive in the
VirtualHost.</p>
</div>
<div class="paragraph">
<p>Then we extract it into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>/etc/httpd/modules</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we edit httpd.conf:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>sudo vi /etc/httpd/conf/httpd.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>We should add the modules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>LoadModule slotmem_module modules/mod_slotmem.so
LoadModule manager_module modules/mod_manager.so
LoadModule proxy_cluster_module modules/mod_proxy_cluster.so
LoadModule advertise_module modules/mod_advertise.so</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note we should comment out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>#LoadModule proxy_balancer_module modules/mod_proxy_balancer.so</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is conflicted with cluster module. And then we need to make httpd
to listen to public address so we could do the testing. Because we
installed httpd on primary host so we know the ip address of it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>Listen 10.211.55.7:80</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we do the necessary configuration at the bottom of httpd.conf:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code># This Listen port is for the mod_cluster-manager, where you can see the status of mod_cluster.
# Port 10001 is not a reserved port, so this prevents problems with SELinux.
Listen 10.211.55.7:10001
# This directive only applies to Red Hat Enterprise Linux. It prevents the temmporary
# files from being written to /etc/httpd/logs/ which is not an appropriate location.
MemManagerFile /var/cache/httpd

&lt;VirtualHost 10.211.55.7:10001&gt;

  &lt;Directory /&gt;
    Order deny,allow
    Deny from all
    Allow from 10.211.55.
  &lt;/Directory&gt;


  # This directive allows you to view mod_cluster status at URL http://10.211.55.4:10001/mod_cluster-manager
  &lt;Location /mod_cluster-manager&gt;
   SetHandler mod_cluster-manager
   Order deny,allow
   Deny from all
   Allow from 10.211.55.
  &lt;/Location&gt;

  KeepAliveTimeout 60
  MaxKeepAliveRequests 0

  ManagerBalancerName other-server-group
  AdvertiseFrequency 5

&lt;/VirtualHost&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For more details on mod_cluster configurations please see this document:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>http://docs.jboss.org/mod_cluster/1.1.0/html/Quick_Start_Guide.html</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testing"><a class="anchor" href="#testing"></a>12.6. Testing</h3>
<div class="paragraph">
<p>If everything goes fine we can start httpd service now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>service httpd start</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we access the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>http://10.211.55.7/cluster-demo/put.jsp</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/clustering/http---10.211.55.7-cluster-demo-put.jsp.png" alt="clustering/http---10.211.55.7-cluster-demo-put.jsp.png"></span></p>
</div>
<div class="paragraph">
<p>We should see the request is distributed to one of the hosts (primary or
secondary) from the WildFly log. For me the request is sent to primary host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[Server:server-three] 16:06:22,256 INFO  [stdout] (http-10.211.55.7-10.211.55.7-8330-4) Putting date now</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now I disconnect the Domain Controller by using the management interface. Select
'runtime' and the server 'primary' in the upper corners.</p>
</div>
<div class="paragraph">
<p>Select 'server-three' and kick the stop button, the active-icon should
change.</p>
</div>
<div class="paragraph">
<p>Killing the server by using system commands will have the effect that
the Host-Controller restart the instance immediately!</p>
</div>
<div class="paragraph">
<p>Then wait for a few seconds and access cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>http://10.211.55.7/cluster-demo/get.jsp</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/clustering/http---10.211.55.7-cluster-demo-get.jsp.png" alt="clustering/http---10.211.55.7-cluster-demo-get.jsp.png"></span></p>
</div>
<div class="paragraph">
<p>Now the request should be served by the secondary host and we should see the log from
the secondary Host Controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>[Server:server-three-secondary] 16:08:29,860 INFO  [stdout] (http-10.211.55.2-10.211.55.2-8330-1) Getting date now</code></pre>
</div>
</div>
<div class="paragraph">
<p>And from the get.jsp we should see that the time we get is the same
we&#8217;ve put by 'put.jsp'. Thus it&#8217;s proven that the session is correctly
replicated to the secondary host.</p>
</div>
<div class="paragraph">
<p>Now we restart the primary Host Controller and should see the host is registered back to
cluster.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It doesn&#8217;t matter if you found the request is distributed to the secondary host at
first time. Then just disconnect the secondary Host Controller and do the testing, the request
should be sent to the primary host instead. The point is we should see the request
is redirect from one host to another and the session is held.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="special-thanks"><a class="anchor" href="#special-thanks"></a>12.7. Special Thanks</h3>
<div class="paragraph">
<p><a href="https://community.jboss.org/people/wdfink">Wolf-Dieter Fink</a> has
contributed the updated add-user.sh usages and configs in host.xml from
7.1.0.Final.<br>
<a href="https://community.jboss.org/people/jfclere">Jean-Frederic Clere</a> provided
the mod_cluster 1.2.0 usages.<br>
Misty Stanley-Jones has given a lot of suggestions and helps to make
this document readable.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to JavaServer Pages (JSP) refer to the Jakarta Server Pages unless otherwise noted
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 32.0.0.Final<br>
Last updated 2023-12-24 15:27:08 -0600
</div>
</div>
</body>
</html>